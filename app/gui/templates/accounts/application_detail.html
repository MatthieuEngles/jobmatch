{% extends 'base.html' %}
{% load markdown_extras %}

{% block title %}{{ application.imported_offer.title }} - Candidature - JobMatch{% endblock %}

{% block extra_css %}
<style>
    .application-detail {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    /* Breadcrumb */
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 1.5rem;
    }

    .breadcrumb a {
        color: #6366f1;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .breadcrumb svg {
        width: 16px;
        height: 16px;
    }

    /* Main layout */
    .detail-layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 2rem;
    }

    @media (max-width: 1024px) {
        .detail-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Main content card */
    .main-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    /* Header section */
    .offer-header {
        padding: 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .offer-source {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 0.75rem;
        margin-bottom: 1rem;
    }

    .offer-source svg {
        width: 14px;
        height: 14px;
    }

    .offer-company {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }

    .offer-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0 0 1rem 0;
        line-height: 1.3;
    }

    .offer-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .offer-meta-item {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.875rem;
        opacity: 0.9;
    }

    .offer-meta-item svg {
        width: 16px;
        height: 16px;
    }

    /* Status bar */
    .status-bar {
        padding: 1.25rem 2rem;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .status-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .status-added { background: #f3f4f6; color: #6b7280; }
    .status-in_progress { background: #fef3c7; color: #d97706; }
    .status-applied { background: #dbeafe; color: #2563eb; }
    .status-interview { background: #e0e7ff; color: #4f46e5; }
    .status-accepted { background: #d1fae5; color: #059669; }
    .status-rejected { background: #fee2e2; color: #dc2626; }

    .status-date {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .status-actions {
        display: flex;
        gap: 0.5rem;
    }

    .status-select {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        font-size: 0.875rem;
        cursor: pointer;
    }

    /* Content sections */
    .content-section {
        padding: 2rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .content-section:last-child {
        border-bottom: none;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .section-icon {
        width: 36px;
        height: 36px;
        background: #f0f9ff;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6366f1;
    }

    .section-icon svg {
        width: 20px;
        height: 20px;
    }

    .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a1a2e;
        margin: 0;
    }

    .section-content {
        color: #374151;
        line-height: 1.7;
    }

    .section-content p {
        margin-bottom: 1rem;
    }

    /* Markdown content styles */
    .markdown-content h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin: 1.5rem 0 0.75rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .markdown-content h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin: 1.25rem 0 0.5rem 0;
    }

    .markdown-content h4 {
        font-size: 1rem;
        font-weight: 600;
        color: #4b5563;
        margin: 1rem 0 0.5rem 0;
    }

    .markdown-content ul, .markdown-content ol {
        margin: 0.5rem 0 1rem 0;
        padding-left: 1.5rem;
    }

    .markdown-content li {
        margin-bottom: 0.375rem;
    }

    .markdown-content strong {
        font-weight: 600;
        color: #1f2937;
    }

    .markdown-content em {
        font-style: italic;
    }

    .markdown-content a {
        color: #667eea;
        text-decoration: none;
    }

    .markdown-content a:hover {
        text-decoration: underline;
    }

    .markdown-content code {
        background: #f3f4f6;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.875em;
    }

    .markdown-content pre {
        background: #1f2937;
        color: #e5e7eb;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1rem 0;
    }

    .markdown-content pre code {
        background: none;
        padding: 0;
        color: inherit;
    }

    .markdown-content blockquote {
        border-left: 4px solid #667eea;
        padding-left: 1rem;
        margin: 1rem 0;
        color: #6b7280;
        font-style: italic;
    }

    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }

    .markdown-content th, .markdown-content td {
        border: 1px solid #e5e7eb;
        padding: 0.5rem 0.75rem;
        text-align: left;
    }

    .markdown-content th {
        background: #f9fafb;
        font-weight: 600;
    }

    /* Skills tags */
    .skills-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .skill-tag {
        padding: 0.375rem 0.875rem;
        background: #f3f4f6;
        border-radius: 20px;
        font-size: 0.8125rem;
        color: #374151;
    }

    /* Sidebar */
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .sidebar-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
    }

    .sidebar-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1a1a2e;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .sidebar-title svg {
        width: 18px;
        height: 18px;
        color: #6366f1;
    }

    /* Progress checklist */
    .progress-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .progress-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #f9fafb;
        border-radius: 10px;
        transition: all 0.2s;
    }

    .progress-item:hover {
        background: #f3f4f6;
    }

    .progress-check {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .progress-check.completed {
        background: #d1fae5;
        color: #059669;
    }

    .progress-check.pending {
        background: #e5e7eb;
        color: #9ca3af;
    }

    .progress-check svg {
        width: 14px;
        height: 14px;
    }

    .progress-text {
        font-size: 0.875rem;
        color: #374151;
    }

    .progress-item.completed .progress-text {
        color: #059669;
    }

    /* Action buttons */
    .action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.875rem 1.25rem;
        border-radius: 10px;
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .action-btn svg {
        width: 18px;
        height: 18px;
    }

    .action-btn-primary {
        background: #6366f1;
        color: white;
    }

    .action-btn-primary:hover {
        background: #4f46e5;
    }

    .action-btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .action-btn-secondary:hover {
        background: #e5e7eb;
    }

    .action-btn-danger {
        background: #fee2e2;
        color: #dc2626;
    }

    .action-btn-danger:hover {
        background: #fecaca;
    }

    /* Timeline / History */
    .timeline {
        position: relative;
        padding-left: 1.5rem;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 0;
        top: 8px;
        bottom: 8px;
        width: 2px;
        background: #e5e7eb;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 1rem;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 6px;
        width: 10px;
        height: 10px;
        background: #6366f1;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 2px #e5e7eb;
    }

    .timeline-date {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-bottom: 0.25rem;
    }

    .timeline-event {
        font-size: 0.875rem;
        color: #374151;
    }

    /* Notes textarea */
    .notes-textarea {
        width: 100%;
        padding: 0.875rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .notes-textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Match score */
    .match-score {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-radius: 12px;
    }

    .match-circle {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: conic-gradient(#6366f1 calc(var(--score) * 3.6deg), #e5e7eb 0);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .match-circle-inner {
        width: 44px;
        height: 44px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 700;
        color: #6366f1;
    }

    .match-info h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1a1a2e;
        margin: 0 0 0.25rem 0;
    }

    .match-info p {
        font-size: 0.75rem;
        color: #6b7280;
        margin: 0;
    }

    /* External link */
    .external-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6366f1;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .external-link:hover {
        text-decoration: underline;
    }

    .external-link svg {
        width: 16px;
        height: 16px;
    }

    /* Interview info */
    .interview-info {
        padding: 1rem;
        background: #fef3c7;
        border-radius: 10px;
        border-left: 4px solid #f59e0b;
    }

    .interview-info h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #92400e;
        margin: 0 0 0.25rem 0;
    }

    .interview-info p {
        font-size: 0.875rem;
        color: #78350f;
        margin: 0;
    }

    /* Preview Modal */
    .preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }

    .preview-modal-content {
        background: white;
        border-radius: 16px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .preview-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .preview-modal-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a1a2e;
    }

    .preview-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        padding: 0.25rem;
        line-height: 1;
    }

    .preview-modal-close:hover {
        color: #1f2937;
    }

    .preview-modal-body {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        font-size: 0.9375rem;
        line-height: 1.7;
        color: #374151;
    }

    /* Markdown styles in preview */
    .preview-modal-body h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a1a2e;
        margin: 0 0 0.5rem 0;
        border-bottom: 2px solid #667eea;
        padding-bottom: 0.5rem;
    }

    .preview-modal-body h2 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #667eea;
        margin: 1.5rem 0 0.75rem 0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .preview-modal-body h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin: 1rem 0 0.5rem 0;
    }

    .preview-modal-body p {
        margin: 0.5rem 0;
    }

    .preview-modal-body ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }

    .preview-modal-body li {
        margin: 0.25rem 0;
    }

    .preview-modal-body hr {
        border: none;
        border-top: 1px solid #e5e7eb;
        margin: 1rem 0;
    }

    .preview-modal-body a {
        color: #667eea;
        text-decoration: none;
    }

    .preview-modal-body a:hover {
        text-decoration: underline;
    }

    .preview-modal-body strong {
        font-weight: 600;
        color: #1f2937;
    }

    .preview-modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
    }

    /* Loading animation for buttons */
    .action-btn.loading {
        position: relative;
        pointer-events: none;
    }

    .action-btn.loading::after {
        content: '';
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: translateY(-50%) rotate(360deg); }
    }

    /* Document item styles */
    .document-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .document-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
    }

    .document-info svg {
        width: 18px;
        height: 18px;
        color: #667eea;
    }

    .document-actions {
        display: flex;
        gap: 0.5rem;
    }

    .doc-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.15s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .doc-action-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.25);
    }

    .doc-action-btn svg {
        width: 16px;
        height: 16px;
    }

    /* CV Adaptation Slider */
    .adaptation-slider-container {
        margin-bottom: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .adaptation-slider-label {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .adaptation-slider-label svg {
        width: 16px;
        height: 16px;
        color: #667eea;
    }

    .adaptation-slider-wrapper {
        position: relative;
        padding: 0 0.25rem;
    }

    .adaptation-slider {
        width: 100%;
        height: 8px;
        -webkit-appearance: none;
        appearance: none;
        background: linear-gradient(to right, #10b981 0%, #f59e0b 50%, #ef4444 100%);
        border-radius: 4px;
        outline: none;
        cursor: pointer;
    }

    .adaptation-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: white;
        border: 3px solid #667eea;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        transition: transform 0.15s ease;
    }

    .adaptation-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }

    .adaptation-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: white;
        border: 3px solid #667eea;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .adaptation-levels {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        padding: 0 0.25rem;
    }

    .adaptation-level-marker {
        width: 8px;
        height: 8px;
        background: #d1d5db;
        border-radius: 50%;
        position: relative;
    }

    .adaptation-level-marker.active {
        background: #667eea;
    }

    .adaptation-description {
        margin-top: 0.75rem;
        padding: 0.625rem;
        background: white;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        font-size: 0.8125rem;
        color: #4b5563;
        line-height: 1.4;
        min-height: 3.5rem;
    }

    .adaptation-description strong {
        color: #1f2937;
        display: block;
        margin-bottom: 0.25rem;
    }

    .adaptation-level-tag {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 0.5rem;
    }

    .adaptation-level-tag.level-1 { background: #d1fae5; color: #059669; }
    .adaptation-level-tag.level-2 { background: #fef3c7; color: #d97706; }
    .adaptation-level-tag.level-3 { background: #fed7aa; color: #c2410c; }
    .adaptation-level-tag.level-4 { background: #fee2e2; color: #dc2626; }
</style>
{% endblock %}

{% block content %}
<div class="application-detail">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="{% url 'home' %}">Accueil</a>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <a href="{% url 'accounts:applications_list' %}">Candidatures</a>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <span>{{ application.imported_offer.title|truncatechars:40 }}</span>
    </nav>

    <div class="detail-layout">
        <!-- Main content -->
        <div class="main-card">
            <!-- Offer header -->
            <div class="offer-header">
                <div class="offer-source">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                    </svg>
                    {{ application.imported_offer.source_domain }}
                </div>
                <div class="offer-company">{{ application.imported_offer.company|default:"Entreprise" }}</div>
                <h1 class="offer-title">{{ application.imported_offer.title }}</h1>
                <div class="offer-meta">
                    {% if application.imported_offer.location %}
                    <span class="offer-meta-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        {{ application.imported_offer.location }}
                    </span>
                    {% endif %}
                    {% if application.imported_offer.contract_type %}
                    <span class="offer-meta-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        {{ application.imported_offer.contract_type }}
                    </span>
                    {% endif %}
                    {% if application.imported_offer.remote_type %}
                    <span class="offer-meta-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                        {{ application.imported_offer.remote_type }}
                    </span>
                    {% endif %}
                    {% if application.imported_offer.salary %}
                    <span class="offer-meta-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        {{ application.imported_offer.get_salary_display }}
                    </span>
                    {% endif %}
                </div>
            </div>

            <!-- Status bar -->
            <div class="status-bar">
                <div class="status-info">
                    <span class="status-badge status-{{ application.status }}">
                        {{ application.get_status_display }}
                    </span>
                    <span class="status-date">
                        Ajoutee le {{ application.created_at|date:"d/m/Y" }}
                    </span>
                </div>
                <div class="status-actions">
                    <form method="post" action="{% url 'accounts:application_update_status' application.id %}" style="display: inline;">
                        {% csrf_token %}
                        <select name="status" class="status-select" onchange="this.form.submit()">
                            <option value="added" {% if application.status == 'added' %}selected{% endif %}>Ajoutee</option>
                            <option value="in_progress" {% if application.status == 'in_progress' %}selected{% endif %}>En cours</option>
                            <option value="applied" {% if application.status == 'applied' %}selected{% endif %}>Candidature envoyee</option>
                            <option value="interview" {% if application.status == 'interview' %}selected{% endif %}>Entretien prevu</option>
                            <option value="accepted" {% if application.status == 'accepted' %}selected{% endif %}>Acceptee</option>
                            <option value="rejected" {% if application.status == 'rejected' %}selected{% endif %}>Refusee</option>
                        </select>
                    </form>
                </div>
            </div>

            <!-- Description -->
            {% if application.imported_offer.description %}
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <h2 class="section-title">Description du poste</h2>
                </div>
                <div class="section-content markdown-content">
                    {{ application.imported_offer.description|markdown }}
                </div>
            </div>
            {% endif %}

            <!-- Skills -->
            {% if application.imported_offer.skills %}
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                        </svg>
                    </div>
                    <h2 class="section-title">Competences recherchees</h2>
                </div>
                <div class="skills-list">
                    {% for skill in application.imported_offer.skills %}
                    <span class="skill-tag">{{ skill }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Notes -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </div>
                    <h2 class="section-title">Mes notes</h2>
                </div>
                <form method="post" action="{% url 'accounts:application_update_notes' application.id %}">
                    {% csrf_token %}
                    <textarea name="notes" class="notes-textarea" placeholder="Ajoutez vos notes personnelles ici...">{{ application.notes }}</textarea>
                    <button type="submit" class="action-btn action-btn-secondary" style="margin-top: 0.75rem; width: auto;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Enregistrer
                    </button>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Match score -->
            {% if application.imported_offer.match_score is not None %}
            <div class="sidebar-card">
                <div class="match-score" style="--score: {{ application.imported_offer.get_match_score_percentage }}">
                    <div class="match-circle">
                        <div class="match-circle-inner">{{ application.imported_offer.get_match_score_percentage }}%</div>
                    </div>
                    <div class="match-info">
                        <h4>Score de compatibilite</h4>
                        <p>Base sur votre profil et l'offre</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Interview info -->
            {% if application.status == 'interview' and application.interview_date %}
            <div class="sidebar-card">
                <div class="interview-info">
                    <h4>Entretien prevu</h4>
                    <p>{{ application.interview_date|date:"l d F Y" }} a {{ application.interview_date|time:"H:i" }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Progress -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    Preparation
                </h3>
                <div class="progress-list">
                    <!-- CV Progress Item -->
                    <div id="cv-progress-item" class="progress-item {% if application.has_cv %}completed{% endif %}">
                        <span class="progress-check {% if application.has_cv %}completed{% else %}pending{% endif %}">
                            {% if application.has_cv %}
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            {% else %}
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="9" stroke-width="2"/>
                            </svg>
                            {% endif %}
                        </span>
                        <span class="progress-text">CV personnalise</span>
                    </div>
                    <!-- Cover Letter Progress Item -->
                    <div id="cover-letter-progress-item" class="progress-item {% if application.has_cover_letter %}completed{% endif %}">
                        <span class="progress-check {% if application.has_cover_letter %}completed{% else %}pending{% endif %}">
                            {% if application.has_cover_letter %}
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            {% else %}
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="9" stroke-width="2"/>
                            </svg>
                            {% endif %}
                        </span>
                        <span class="progress-text">Lettre de motivation</span>
                    </div>
                </div>

                <!-- CV Adaptation Level Slider -->
                <div class="adaptation-slider-container">
                    <label class="adaptation-slider-label">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                        </svg>
                        Niveau d'adaptation du CV
                    </label>
                    <div class="adaptation-slider-wrapper">
                        <input type="range" id="adaptation-level" class="adaptation-slider" min="1" max="4" value="2" step="1">
                        <div class="adaptation-levels">
                            <span class="adaptation-level-marker" data-level="1"></span>
                            <span class="adaptation-level-marker active" data-level="2"></span>
                            <span class="adaptation-level-marker" data-level="3"></span>
                            <span class="adaptation-level-marker" data-level="4"></span>
                        </div>
                    </div>
                    <div id="adaptation-description" class="adaptation-description">
                        <span class="adaptation-level-tag level-2">Niveau 2</span>
                        <strong>Adaptation moderee</strong>
                        On force un peu le matching avec l'offre, en reformulant les experiences pour mieux correspondre, sans mentir sur les competences.
                    </div>
                </div>

                <!-- Generation buttons -->
                <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                    <!-- CV Generation Button -->
                    <button type="button" id="generate-cv-btn" class="action-btn action-btn-primary">
                        <svg id="cv-btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span id="cv-btn-text">{% if application.has_cv %}Regenerer le CV{% else %}Generer le CV{% endif %}</span>
                    </button>

                    <!-- Cover Letter Generation Button -->
                    <button type="button" id="generate-cover-letter-btn" class="action-btn action-btn-secondary">
                        <svg id="cover-letter-btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <span id="cover-letter-btn-text">{% if application.has_cover_letter %}Regenerer la lettre{% else %}Generer la lettre{% endif %}</span>
                    </button>
                </div>

                <!-- Status message -->
                <div id="generation-status" style="display: none; margin-top: 0.75rem; padding: 0.75rem; border-radius: 8px; font-size: 0.875rem;">
                </div>
            </div>

            <!-- Generated Content Preview -->
            {% if application.custom_cv or application.cover_letter %}
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Documents generes
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    {% if application.custom_cv %}
                    <div class="document-item">
                        <div class="document-info">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span>CV personnalise</span>
                        </div>
                        <div class="document-actions">
                            <button type="button" onclick="showPreview('cv')" class="doc-action-btn" title="Voir">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>
                            <button type="button" onclick="downloadDocx('cv')" class="doc-action-btn" title="Telecharger DOCX">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    {% if application.cover_letter %}
                    <div class="document-item">
                        <div class="document-info">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <span>Lettre de motivation</span>
                        </div>
                        <div class="document-actions">
                            <button type="button" onclick="showPreview('cover_letter')" class="doc-action-btn" title="Voir">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>
                            <button type="button" onclick="downloadDocx('cover_letter')" class="doc-action-btn" title="Telecharger DOCX">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5.586a1 1 0 01.293-.707l5.414-5.414a1 1 0 01.707-.293H19a2 2 0 012 2v16a2 2 0 01-2 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Actions
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <a href="{{ application.imported_offer.source_url }}" target="_blank" class="action-btn action-btn-secondary">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        Voir l'offre originale
                    </a>
                    <form method="post" action="{% url 'accounts:application_delete' application.id %}" onsubmit="return confirm('Etes-vous sur de vouloir supprimer cette candidature ?');">
                        {% csrf_token %}
                        <button type="submit" class="action-btn action-btn-danger">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Supprimer
                        </button>
                    </form>
                </div>
            </div>

            <!-- History -->
            {% if application.history %}
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Historique
                </h3>
                <div class="timeline">
                    {% for event in application.history reversed %}
                    <div class="timeline-item">
                        <div class="timeline-date">{{ event.date|slice:":10" }}</div>
                        <div class="timeline-event">
                            {% if event.event == 'created' %}Candidature creee
                            {% elif event.event == 'status_changed' %}Statut modifie
                            {% elif event.event == 'cv_generated' %}CV genere
                            {% elif event.event == 'cover_letter_generated' %}Lettre generee
                            {% elif event.event == 'applied' %}Candidature envoyee
                            {% elif event.event == 'interview_scheduled' %}Entretien planifie
                            {% elif event.event == 'note_added' %}Note ajoutee
                            {% else %}{{ event.event }}{% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="preview-modal" style="display: none;">
    <div class="preview-modal-content">
        <div class="preview-modal-header">
            <h3 id="preview-modal-title">Document</h3>
            <button onclick="closePreview()" class="preview-modal-close">&times;</button>
        </div>
        <div id="preview-modal-body" class="preview-modal-body">
        </div>
        <div class="preview-modal-footer">
            <button type="button" id="preview-download-btn" onclick="downloadCurrentDocx()" class="action-btn action-btn-secondary" style="display: flex; align-items: center; gap: 6px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Telecharger DOCX
            </button>
            <button onclick="closePreview()" class="action-btn action-btn-primary">Fermer</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Marked.js for markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // CSRF token for AJAX requests
    const csrfToken = '{{ csrf_token }}';
    const applicationId = {{ application.id }};

    // URLs for generation endpoints
    const generateCvUrl = '{% url "accounts:application_generate_cv" application.id %}';
    const generateCoverLetterUrl = '{% url "accounts:application_generate_cover_letter" application.id %}';
    const saveCvUrl = '{% url "accounts:application_save_cv" application.id %}';
    const saveCoverLetterUrl = '{% url "accounts:application_save_cover_letter" application.id %}';

    // Stored generated content
    let generatedCvContent = {% if application.custom_cv %}"{{ application.custom_cv|escapejs }}"{% else %}null{% endif %};
    let generatedCoverLetterContent = {% if application.cover_letter %}"{{ application.cover_letter|escapejs }}"{% else %}null{% endif %};

    // Button elements
    const generateCvBtn = document.getElementById('generate-cv-btn');
    const generateCoverLetterBtn = document.getElementById('generate-cover-letter-btn');
    const cvBtnText = document.getElementById('cv-btn-text');
    const coverLetterBtnText = document.getElementById('cover-letter-btn-text');
    const statusDiv = document.getElementById('generation-status');

    // Progress item elements
    const cvProgressItem = document.getElementById('cv-progress-item');
    const coverLetterProgressItem = document.getElementById('cover-letter-progress-item');

    // Adaptation level slider
    const adaptationSlider = document.getElementById('adaptation-level');
    const adaptationDescription = document.getElementById('adaptation-description');
    const adaptationLevelMarkers = document.querySelectorAll('.adaptation-level-marker');

    // Adaptation level descriptions
    const adaptationLevels = {
        1: {
            tag: 'Niveau 1',
            tagClass: 'level-1',
            title: 'Fidele au profil',
            description: 'On reprend quasi a l\'identique le profil du candidat, sans forcer l\'adaptation a l\'offre.'
        },
        2: {
            tag: 'Niveau 2',
            tagClass: 'level-2',
            title: 'Adaptation moderee',
            description: 'On force un peu le matching avec l\'offre, en reformulant les experiences pour mieux correspondre, sans mentir sur les competences.'
        },
        3: {
            tag: 'Niveau 3',
            tagClass: 'level-3',
            title: 'Adaptation forte',
            description: 'On force fortement le matching : on ajoute les skills presentes dans l\'offre si le candidat pourrait les avoir, meme si non explicites.'
        },
        4: {
            tag: 'Niveau 4',
            tagClass: 'level-4',
            title: 'Match quasi-parfait',
            description: 'On veut un match quasi parfait avec l\'offre. Le CV sera tres optimise mais pourrait contenir des competences non verifiables.'
        }
    };

    // Update adaptation description when slider changes
    function updateAdaptationDescription(level) {
        const info = adaptationLevels[level];
        adaptationDescription.innerHTML = `
            <span class="adaptation-level-tag ${info.tagClass}">${info.tag}</span>
            <strong>${info.title}</strong>
            ${info.description}
        `;

        // Update markers
        adaptationLevelMarkers.forEach(marker => {
            const markerLevel = parseInt(marker.dataset.level);
            marker.classList.toggle('active', markerLevel <= level);
        });
    }

    if (adaptationSlider) {
        // Load saved value from localStorage
        const savedLevel = localStorage.getItem('cv_adaptation_level');
        if (savedLevel) {
            adaptationSlider.value = savedLevel;
            updateAdaptationDescription(parseInt(savedLevel));
        }

        // Save to localStorage on change
        adaptationSlider.addEventListener('input', function() {
            const level = parseInt(this.value);
            updateAdaptationDescription(level);
            localStorage.setItem('cv_adaptation_level', level);
        });
    }

    // Show status message
    function showStatus(message, type) {
        statusDiv.style.display = 'block';
        statusDiv.textContent = message;
        if (type === 'success') {
            statusDiv.style.background = '#d1fae5';
            statusDiv.style.color = '#059669';
        } else if (type === 'error') {
            statusDiv.style.background = '#fee2e2';
            statusDiv.style.color = '#dc2626';
        } else {
            statusDiv.style.background = '#fef3c7';
            statusDiv.style.color = '#d97706';
        }
    }

    // Hide status message
    function hideStatus() {
        statusDiv.style.display = 'none';
    }

    // Update button to loading state
    function setButtonLoading(btn, textEl, isLoading, originalText) {
        if (isLoading) {
            btn.disabled = true;
            textEl.textContent = 'Generation en cours...';
            btn.classList.add('loading');
        } else {
            btn.disabled = false;
            textEl.textContent = originalText;
            btn.classList.remove('loading');
        }
    }

    // Update progress item to completed state
    function markProgressComplete(element) {
        element.classList.add('completed');
        const check = element.querySelector('.progress-check');
        check.classList.remove('pending');
        check.classList.add('completed');
        check.innerHTML = '<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
    }

    // Poll for task status
    async function pollTaskStatus(taskId, onComplete, onError) {
        const statusUrl = '{% url "accounts:application_generation_status" application.id "TASK_ID" %}'.replace('TASK_ID', taskId);

        const poll = async () => {
            try {
                const response = await fetch(statusUrl);
                const data = await response.json();

                if (data.status === 'completed') {
                    onComplete(data.content);
                } else if (data.status === 'failed') {
                    onError(data.error || 'Une erreur est survenue');
                } else {
                    // Keep polling
                    setTimeout(poll, 2000);
                }
            } catch (error) {
                onError('Erreur de connexion');
            }
        };

        poll();
    }

    // Generate CV
    async function generateCv() {
        setButtonLoading(generateCvBtn, cvBtnText, true, 'Generer le CV');
        showStatus('Generation du CV en cours...', 'info');

        // Get adaptation level
        const adaptationLevel = adaptationSlider ? parseInt(adaptationSlider.value) : 2;

        try {
            const response = await fetch(generateCvUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ adaptation_level: adaptationLevel })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Erreur lors du lancement de la generation');
            }

            // Start polling
            pollTaskStatus(
                data.task_id,
                async (content) => {
                    generatedCvContent = content;
                    // Save to database
                    await saveCv(content);
                    markProgressComplete(cvProgressItem);
                    setButtonLoading(generateCvBtn, cvBtnText, false, 'Regenerer le CV');
                    showStatus('CV genere avec succes !', 'success');
                    setTimeout(() => location.reload(), 1500);
                },
                (error) => {
                    setButtonLoading(generateCvBtn, cvBtnText, false, 'Generer le CV');
                    showStatus(error, 'error');
                }
            );

        } catch (error) {
            setButtonLoading(generateCvBtn, cvBtnText, false, 'Generer le CV');
            showStatus(error.message, 'error');
        }
    }

    // Generate Cover Letter
    async function generateCoverLetter() {
        setButtonLoading(generateCoverLetterBtn, coverLetterBtnText, true, 'Generer la lettre');
        showStatus('Generation de la lettre en cours...', 'info');

        try {
            const response = await fetch(generateCoverLetterUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Erreur lors du lancement de la generation');
            }

            // Start polling
            pollTaskStatus(
                data.task_id,
                async (content) => {
                    generatedCoverLetterContent = content;
                    // Save to database
                    await saveCoverLetter(content);
                    markProgressComplete(coverLetterProgressItem);
                    setButtonLoading(generateCoverLetterBtn, coverLetterBtnText, false, 'Regenerer la lettre');
                    showStatus('Lettre generee avec succes !', 'success');
                    setTimeout(() => location.reload(), 1500);
                },
                (error) => {
                    setButtonLoading(generateCoverLetterBtn, coverLetterBtnText, false, 'Generer la lettre');
                    showStatus(error, 'error');
                }
            );

        } catch (error) {
            setButtonLoading(generateCoverLetterBtn, coverLetterBtnText, false, 'Generer la lettre');
            showStatus(error.message, 'error');
        }
    }

    // Save CV to database
    async function saveCv(content) {
        try {
            await fetch(saveCvUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content })
            });
        } catch (error) {
            console.error('Error saving CV:', error);
        }
    }

    // Save cover letter to database
    async function saveCoverLetter(content) {
        try {
            await fetch(saveCoverLetterUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content })
            });
        } catch (error) {
            console.error('Error saving cover letter:', error);
        }
    }

    // Current preview type (for download button)
    let currentPreviewType = null;

    // Render markdown to HTML
    function renderMarkdown(content) {
        if (!content) return '';
        // Use marked.js to render markdown
        if (typeof marked !== 'undefined') {
            return marked.parse(content);
        }
        // Fallback: escape HTML and show as pre
        return `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${escapeHtml(content)}</pre>`;
    }

    // Preview modal functions
    function showPreview(type) {
        const modal = document.getElementById('preview-modal');
        const title = document.getElementById('preview-modal-title');
        const body = document.getElementById('preview-modal-body');

        currentPreviewType = type;

        if (type === 'cv') {
            title.textContent = 'CV personnalise';
            body.innerHTML = generatedCvContent ? renderMarkdown(generatedCvContent) : '<p>Aucun CV genere</p>';
        } else {
            title.textContent = 'Lettre de motivation';
            body.innerHTML = generatedCoverLetterContent ? renderMarkdown(generatedCoverLetterContent) : '<p>Aucune lettre generee</p>';
        }

        modal.style.display = 'flex';
    }

    function closePreview() {
        document.getElementById('preview-modal').style.display = 'none';
        currentPreviewType = null;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Download DOCX for a specific document type
    async function downloadDocx(type) {
        const content = type === 'cv' ? generatedCvContent : generatedCoverLetterContent;
        const docTitle = type === 'cv' ? 'CV personnalise' : 'Lettre de motivation';
        const fileName = type === 'cv' ? 'cv_personnalise' : 'lettre_motivation';

        if (!content) {
            alert('Aucun contenu a telecharger');
            return;
        }

        await generateDocx(content, docTitle, fileName);
    }

    // Download the currently previewed document
    async function downloadCurrentDocx() {
        if (!currentPreviewType) return;
        await downloadDocx(currentPreviewType);
    }

    // DOCX template configuration from user settings
    const docxTemplateConfig = JSON.parse('{{ docx_template_config|default:"{\"fontName\":\"Calibri\",\"fontSizeName\":32,\"fontSizeSection\":24,\"fontSizeBody\":20,\"accentColor\":\"667eea\",\"marginTop\":1134,\"marginRight\":1134,\"marginBottom\":1134,\"marginLeft\":1134,\"lineSpacing\":276,\"paragraphSpacingAfter\":120}"|escapejs }}');

    // Generate and download DOCX
    async function generateDocx(content, title, fileName) {
        const btn = document.getElementById('preview-download-btn');
        const originalHTML = btn ? btn.innerHTML : '';
        const tpl = docxTemplateConfig;

        try {
            if (btn) {
                btn.innerHTML = '<span style="display:flex;align-items:center;gap:6px;">Chargement...</span>';
                btn.disabled = true;
            }

            // Load docx library dynamically if not already loaded
            if (!window.docx) {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/docx@8.5.0/build/index.umd.js';
                document.head.appendChild(script);
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = () => reject(new Error('Failed to load docx library'));
                });
            }

            const { Document, Packer, Paragraph, TextRun, HeadingLevel, ExternalHyperlink, convertInchesToTwip } = window.docx;

            // Parse inline markdown and return array of TextRun objects
            function parseInlineMarkdown(text, baseSize = tpl.fontSizeBody) {
                const runs = [];
                // Pattern to match **bold**, *italic*, and [link](url)
                const regex = /(\*\*([^*]+)\*\*|\*([^*]+)\*|\[([^\]]+)\]\(([^)]+)\))/g;
                let lastIndex = 0;
                let match;

                while ((match = regex.exec(text)) !== null) {
                    // Add text before match
                    if (match.index > lastIndex) {
                        runs.push(new TextRun({
                            text: text.slice(lastIndex, match.index),
                            font: tpl.fontName,
                            size: baseSize
                        }));
                    }

                    if (match[2]) {
                        // **bold**
                        runs.push(new TextRun({
                            text: match[2],
                            bold: true,
                            font: tpl.fontName,
                            size: baseSize
                        }));
                    } else if (match[3]) {
                        // *italic*
                        runs.push(new TextRun({
                            text: match[3],
                            italics: true,
                            font: tpl.fontName,
                            size: baseSize
                        }));
                    } else if (match[4] && match[5]) {
                        // [link](url) - just show text, DOCX hyperlinks are complex
                        runs.push(new TextRun({
                            text: match[4],
                            color: tpl.accentColor,
                            underline: {},
                            font: tpl.fontName,
                            size: baseSize
                        }));
                    }

                    lastIndex = regex.lastIndex;
                }

                // Add remaining text
                if (lastIndex < text.length) {
                    runs.push(new TextRun({
                        text: text.slice(lastIndex),
                        font: tpl.fontName,
                        size: baseSize
                    }));
                }

                return runs.length > 0 ? runs : [new TextRun({
                    text,
                    font: tpl.fontName,
                    size: baseSize
                })];
            }

            // Split content into paragraphs
            const lines = content.split('\n');
            const paragraphs = [];

            // Process each line
            for (const line of lines) {
                const trimmedLine = line.trim();

                // Markdown H1: # Title (candidate name)
                if (/^#\s+/.test(trimmedLine)) {
                    const headingText = trimmedLine.replace(/^#\s+/, '');
                    paragraphs.push(new Paragraph({
                        children: [new TextRun({
                            text: headingText,
                            bold: true,
                            size: tpl.fontSizeName,
                            font: tpl.fontName
                        })],
                        spacing: { after: tpl.paragraphSpacingAfter * 2, line: tpl.lineSpacing },
                    }));
                }
                // Markdown H2: ## Section
                else if (/^##\s+/.test(trimmedLine)) {
                    const sectionTitle = trimmedLine.replace(/^##\s+/, '');
                    paragraphs.push(new Paragraph({ text: '' }));
                    paragraphs.push(new Paragraph({
                        children: [new TextRun({
                            text: sectionTitle.toUpperCase(),
                            bold: true,
                            color: tpl.accentColor,
                            size: tpl.fontSizeSection,
                            font: tpl.fontName
                        })],
                        spacing: { before: 300, after: tpl.paragraphSpacingAfter, line: tpl.lineSpacing },
                    }));
                }
                // Markdown H3: ### Subsection
                else if (/^###\s+/.test(trimmedLine)) {
                    const subsectionTitle = trimmedLine.replace(/^###\s+/, '');
                    // Subsection uses body size but bold
                    const subsectionSize = Math.round(tpl.fontSizeBody * 1.1);
                    paragraphs.push(new Paragraph({
                        children: [new TextRun({
                            text: subsectionTitle,
                            bold: true,
                            font: tpl.fontName,
                            size: subsectionSize
                        })],
                        spacing: { before: 200, after: 50, line: tpl.lineSpacing },
                    }));
                }
                // Horizontal rule: ---
                else if (/^-{3,}$/.test(trimmedLine)) {
                    // Skip horizontal rules in DOCX (sections are already separated)
                    paragraphs.push(new Paragraph({ text: '' }));
                }
                // Bullet point: - or * at start
                else if (/^[-*]\s/.test(trimmedLine)) {
                    const bulletText = trimmedLine.replace(/^[-*]\s*/, '');
                    paragraphs.push(new Paragraph({
                        children: parseInlineMarkdown(bulletText),
                        bullet: { level: 0 },
                        spacing: { line: tpl.lineSpacing },
                    }));
                }
                // Regular text with potential inline markdown
                else if (trimmedLine) {
                    paragraphs.push(new Paragraph({
                        children: parseInlineMarkdown(trimmedLine),
                        spacing: { after: tpl.paragraphSpacingAfter, line: tpl.lineSpacing },
                    }));
                }
                // Empty line
                else {
                    paragraphs.push(new Paragraph({ text: '' }));
                }
            }

            // Create document with template settings
            const doc = new Document({
                styles: {
                    default: {
                        document: {
                            run: {
                                font: tpl.fontName,
                                size: tpl.fontSizeBody,
                            },
                        },
                    },
                },
                sections: [{
                    properties: {
                        page: {
                            margin: {
                                top: tpl.marginTop,
                                right: tpl.marginRight,
                                bottom: tpl.marginBottom,
                                left: tpl.marginLeft,
                            },
                        },
                    },
                    children: paragraphs,
                }],
            });

            // Generate and download
            const blob = await Packer.toBlob(doc);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}_{{ application.imported_offer.company|default:"candidature"|slugify }}.docx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (btn) {
                btn.innerHTML = '<span style="display:flex;align-items:center;gap:6px;">Telecharge !</span>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 2000);
            }
        } catch (error) {
            console.error('Export DOCX error:', error);
            alert('Erreur lors de l\'export: ' + error.message);
            if (btn) {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }
    }

    // Event listeners
    if (generateCvBtn) {
        generateCvBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('CV generation button clicked');
            generateCv();
        });
    } else {
        console.error('CV button not found');
    }

    if (generateCoverLetterBtn) {
        generateCoverLetterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Cover letter generation button clicked');
            generateCoverLetter();
        });
    } else {
        console.error('Cover letter button not found');
    }

    // Close modal on outside click
    const previewModal = document.getElementById('preview-modal');
    if (previewModal) {
        previewModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closePreview();
            }
        });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePreview();
        }
    });

    console.log('Generation script loaded successfully');
</script>
{% endblock %}
