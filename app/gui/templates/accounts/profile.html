{% extends "base.html" %}

{% block title %}Mon profil - JobMatch{% endblock %}

{% block extra_css %}
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --secondary: #06b6d4;
        --dark: #0f172a;
        --light: #f8fafc;
        --gray: #64748b;
        --border: #e2e8f0;
    }

    .profile-layout {
        display: flex;
        gap: 32px;
        height: calc(100vh - 80px);
        padding: 20px 0;
        overflow: hidden;
    }

    /* Sidebar styles */
    .profile-sidebar {
        width: 280px;
        flex-shrink: 0;
        overflow-y: auto;
    }

    .profile-card {
        background: white;
        border-radius: 24px;
        border: 1px solid var(--border);
        overflow: hidden;
        position: sticky;
        top: 24px;
    }

    .profile-header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        padding: 32px;
        text-align: center;
        position: relative;
    }

    .photo-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 16px;
    }

    .profile-photo {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: var(--primary);
        border: 4px solid white;
        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        overflow: hidden;
    }

    .profile-photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .photo-upload-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 36px;
        height: 36px;
        background: white;
        border-radius: 50%;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .photo-upload-btn:hover {
        transform: scale(1.1);
        background: var(--light);
    }

    .photo-upload-btn svg {
        width: 18px;
        height: 18px;
        color: var(--primary);
    }

    .profile-name {
        color: white;
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .profile-email {
        color: rgba(255,255,255,0.8);
        font-size: 0.875rem;
    }

    /* Navigation menu */
    .profile-menu {
        padding: 16px 0;
    }

    .menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 24px;
        color: var(--dark);
        text-decoration: none;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        font-weight: 500;
    }

    .menu-item:hover {
        background: var(--light);
        color: var(--primary);
    }

    .menu-item.active {
        background: linear-gradient(90deg, rgba(79, 70, 229, 0.1), transparent);
        color: var(--primary);
        border-left-color: var(--primary);
    }

    .menu-item svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
    }

    .menu-divider {
        height: 1px;
        background: var(--border);
        margin: 12px 24px;
    }

    .menu-item.danger {
        color: #dc2626;
    }

    .menu-item.danger:hover {
        background: #fef2f2;
    }

    /* Candidate profile selector */
    .candidate-profile-selector {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
    }

    .candidate-profile-selector label {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--gray);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .candidate-profile-row {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .candidate-profile-select {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .candidate-profile-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    .profile-action-btn {
        width: 36px;
        height: 36px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .profile-action-btn:hover {
        border-color: var(--primary);
        background: var(--light);
    }

    .profile-action-btn svg {
        width: 16px;
        height: 16px;
        color: var(--gray);
    }

    .profile-action-btn:hover svg {
        color: var(--primary);
    }

    .profile-action-btn.danger:hover {
        border-color: #dc2626;
        background: #fef2f2;
    }

    .profile-action-btn.danger:hover svg {
        color: #dc2626;
    }

    /* Item checkbox for profile selection */
    .extracted-item {
        position: relative;
    }

    .extracted-item.deselected,
    .skill-tag.deselected {
        opacity: 0.4;
        background: #f0f0f0 !important;
    }

    /* Profile modal */
    .profile-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .profile-modal-overlay.show {
        display: flex;
    }

    .profile-modal {
        background: white;
        border-radius: 16px;
        padding: 24px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .profile-modal h3 {
        margin: 0 0 20px;
        font-size: 1.25rem;
        color: var(--dark);
    }

    .profile-modal-field {
        margin-bottom: 16px;
    }

    .profile-modal-field label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 6px;
    }

    .profile-modal-field input,
    .profile-modal-field textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.95rem;
        box-sizing: border-box;
    }

    .profile-modal-field textarea {
        resize: vertical;
        min-height: 80px;
    }

    .profile-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .profile-modal-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .profile-modal-btn.cancel {
        background: var(--light);
        border: 1px solid var(--border);
        color: var(--dark);
    }

    .profile-modal-btn.cancel:hover {
        background: #e5e5e5;
    }

    .profile-modal-btn.confirm {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border: none;
        color: white;
    }

    .profile-modal-btn.confirm:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    /* Photo modal */
    .photo-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1001;
        align-items: center;
        justify-content: center;
    }

    .photo-modal-overlay.show {
        display: flex;
    }

    .photo-modal {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 420px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.35);
        overflow: hidden;
    }

    .photo-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
    }

    .photo-modal-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--dark);
    }

    .photo-modal-close {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: var(--gray);
        transition: color 0.2s;
    }

    .photo-modal-close:hover {
        color: var(--dark);
    }

    .photo-modal-body {
        padding: 24px;
    }

    .photo-preview-container {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }

    .photo-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        overflow: hidden;
        background: var(--light);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid var(--border);
    }

    .photo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .photo-preview-placeholder {
        color: var(--gray);
    }

    .photo-upload-zone {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--gray);
    }

    .photo-upload-zone:hover,
    .photo-upload-zone.dragover {
        border-color: var(--primary);
        background: rgba(79, 70, 229, 0.05);
        color: var(--primary);
    }

    .photo-upload-zone svg {
        margin-bottom: 8px;
    }

    .photo-upload-text {
        font-size: 0.95rem;
        font-weight: 500;
        margin: 0 0 4px;
    }

    .photo-upload-hint {
        font-size: 0.8rem;
        margin: 0;
        opacity: 0.7;
    }

    .photo-progress {
        margin-top: 16px;
    }

    .photo-progress-bar {
        height: 6px;
        background: var(--light);
        border-radius: 3px;
        overflow: hidden;
    }

    .photo-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        width: 0%;
        transition: width 0.3s;
    }

    .photo-progress-text {
        font-size: 0.85rem;
        color: var(--gray);
        text-align: center;
        margin: 8px 0 0;
    }

    .photo-modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 16px 24px;
        background: var(--light);
        border-top: 1px solid var(--border);
    }

    .photo-modal-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .photo-modal-btn.cancel {
        background: white;
        border: 1px solid var(--border);
        color: var(--dark);
    }

    .photo-modal-btn.cancel:hover {
        background: #f5f5f5;
    }

    .photo-modal-btn.delete {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        margin-right: auto;
    }

    .photo-modal-btn.delete:hover {
        background: #fee2e2;
    }

    .photo-modal-btn.confirm {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border: none;
        color: white;
    }

    .photo-modal-btn.confirm:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    /* Cropper container */
    .photo-crop-container {
        width: 100%;
        height: 300px;
        background: #1a1a2e;
        border-radius: 12px;
        overflow: hidden;
    }

    .photo-crop-container img {
        display: block;
        max-width: 100%;
    }

    .photo-crop-hint {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 12px;
        font-size: 0.85rem;
        color: var(--gray);
    }

    /* Cropper.js custom styles */
    .cropper-view-box,
    .cropper-face {
        border-radius: 50%;
    }

    .cropper-view-box {
        box-shadow: 0 0 0 1px #39f;
        outline: 0;
    }

    .cropper-face {
        background-color: inherit !important;
    }

    .cropper-dashed,
    .cropper-point.point-se,
    .cropper-point.point-sw,
    .cropper-point.point-nw,
    .cropper-point.point-ne,
    .cropper-line {
        display: none !important;
    }

    .cropper-modal {
        background: rgba(0, 0, 0, 0.7);
    }

    /* Main content area */
    .profile-content {
        flex: 1;
        min-width: 0;
        overflow-y: auto;
    }

    .content-card {
        background: white;
        border-radius: 24px;
        border: 1px solid var(--border);
        padding: 40px;
    }

    .content-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
    }

    .content-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0;
    }

    .content-subtitle {
        color: var(--gray);
        font-size: 0.95rem;
        margin-top: 4px;
    }

    /* Form styles */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .form-group.full-width {
        grid-column: span 2;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark);
        font-size: 0.875rem;
    }

    .form-control {
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        outline: none;
    }

    .form-select {
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 1rem;
        background-color: white;
    }

    .btn-save {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 14px 32px;
        border-radius: 12px;
        border: none;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(79, 70, 229, 0.3);
    }

    /* Form sections */
    .form-section {
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
    }

    .form-section:last-of-type {
        border-bottom: none;
        margin-bottom: 16px;
    }

    .form-section-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 16px;
    }

    .form-hint {
        font-size: 0.8rem;
        color: var(--gray);
    }

    /* Social links */
    .social-link-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--light);
        border-radius: 10px;
        margin-bottom: 8px;
    }

    .link-type-badge {
        background: var(--primary);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 80px;
        text-align: center;
    }

    .link-url {
        flex: 1;
        color: var(--primary);
        text-decoration: none;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .link-url:hover {
        text-decoration: underline;
    }

    .btn-delete-link {
        background: none;
        border: none;
        color: #dc2626;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .btn-delete-link:hover {
        background: #fef2f2;
    }

    .empty-links-message {
        color: var(--gray);
        font-style: italic;
        padding: 16px;
        text-align: center;
    }

    .add-link-form {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .add-link-form .link-type-select {
        width: 140px;
        flex-shrink: 0;
    }

    .add-link-form input {
        flex: 1;
    }

    .btn-add-link {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .btn-add-link:hover {
        background: var(--primary-dark);
    }

    /* Contract checkboxes */
    .contract-checkboxes {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 12px;
    }

    .contract-checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 10px 16px;
        border: 1px solid var(--border);
        border-radius: 10px;
        transition: all 0.2s;
    }

    .contract-checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
    }

    .contract-checkbox-label:hover {
        border-color: var(--primary);
        background: rgba(79, 70, 229, 0.05);
    }

    .contract-checkbox-label:has(input:checked) {
        border-color: var(--primary);
        background: rgba(79, 70, 229, 0.1);
    }

    /* Salary slider */
    .salary-slider-container {
        background: var(--light);
        padding: 24px;
        border-radius: 16px;
    }

    .salary-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .salary-label {
        font-weight: 600;
        color: var(--dark);
    }

    .salary-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary);
    }

    .salary-slider-wrapper {
        position: relative;
        height: 8px;
        margin: 30px 0;
    }

    .slider-track {
        position: absolute;
        width: 100%;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        top: 0;
    }

    .slider-range {
        position: absolute;
        height: 8px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 4px;
        top: 0;
    }

    .salary-slider {
        position: absolute;
        width: 100%;
        height: 8px;
        background: transparent;
        pointer-events: none;
        -webkit-appearance: none;
        top: 0;
    }

    .salary-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: white;
        border: 3px solid var(--primary);
        border-radius: 50%;
        cursor: pointer;
        pointer-events: all;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: all 0.2s;
    }

    .salary-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .salary-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: white;
        border: 3px solid var(--primary);
        border-radius: 50%;
        cursor: pointer;
        pointer-events: all;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .salary-bounds {
        display: flex;
        justify-content: space-between;
        color: var(--gray);
        font-size: 0.85rem;
    }

    /* Empty state placeholder sections */
    .placeholder-section {
        text-align: center;
        padding: 60px 40px;
        background: var(--light);
        border-radius: 16px;
        border: 2px dashed var(--border);
    }

    .placeholder-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .placeholder-icon svg {
        width: 32px;
        height: 32px;
        color: white;
    }

    .placeholder-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 8px;
    }

    .placeholder-desc {
        color: var(--gray);
        margin-bottom: 24px;
    }

    .btn-add {
        background: white;
        color: var(--primary);
        padding: 12px 24px;
        border-radius: 12px;
        border: 1px solid var(--primary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-add:hover {
        background: var(--primary);
        color: white;
    }

    /* Career path tabs */
    .tabs-container {
        margin-bottom: 24px;
    }

    .tabs-nav {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 0;
    }

    .tab-btn {
        padding: 12px 24px;
        background: none;
        border: none;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--gray);
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }

    .tab-btn:hover {
        color: var(--primary);
    }

    .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .tab-btn svg {
        width: 18px;
        height: 18px;
        margin-right: 8px;
        vertical-align: middle;
    }

    .tab-content {
        display: none;
        padding-top: 24px;
    }

    .tab-content.active {
        display: block;
    }

    /* Extracted line items display */
    .extracted-items {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .extracted-item {
        background: var(--light);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 20px;
        transition: all 0.2s ease;
        position: relative;
    }

    .extracted-item:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 8px rgba(79, 70, 229, 0.1);
    }

    .extracted-item.inactive {
        opacity: 0.5;
        background: #f8f8f8;
    }

    .extracted-item-header {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--gray);
    }

    .extracted-item-header .item-entity {
        color: var(--primary);
    }

    .extracted-item-header .item-dates {
        color: var(--gray);
    }

    .extracted-item-header .item-dates::before {
        content: "|";
        margin-right: 8px;
        color: var(--border);
    }

    .extracted-item-header .item-position {
        color: var(--dark);
    }

    .extracted-item-header .item-position::before {
        content: "|";
        margin-right: 8px;
        color: var(--border);
    }

    .extracted-item-content {
        font-size: 0.95rem;
        color: var(--dark);
        line-height: 1.5;
        white-space: pre-wrap;
        flex: 1;
    }

    .extracted-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border);
    }

    .extracted-item-source {
        font-size: 0.8rem;
        color: var(--gray);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .extracted-item-source svg {
        width: 14px;
        height: 14px;
    }

    .extracted-item-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-edit-item {
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px;
        color: var(--gray);
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-edit-item:hover {
        background: var(--light);
        color: var(--primary);
    }

    .btn-edit-item svg {
        width: 16px;
        height: 16px;
    }

    /* Toggle switch for active/inactive */
    .toggle-switch {
        position: relative;
        width: 40px;
        height: 22px;
        cursor: pointer;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #dc2626;
        border-radius: 22px;
        transition: 0.3s;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        border-radius: 50%;
        transition: 0.3s;
    }

    .toggle-switch input:checked + .toggle-slider {
        background-color: #22c55e;
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(18px);
    }

    .btn-toggle-active {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: var(--gray);
        transition: color 0.2s ease;
    }

    .btn-toggle-active:hover {
        color: var(--primary);
    }

    /* Skills grid layout */
    .skills-section {
        margin-bottom: 24px;
    }

    .skills-section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
    }

    .skills-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .skill-tag {
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 14px;
        font-size: 0.9rem;
        color: var(--dark);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .skill-tag:hover {
        border-color: var(--primary);
        background: var(--light);
    }

    .skill-tag.hard {
        border-left: 3px solid var(--primary);
    }

    .skill-tag.soft {
        border-left: 3px solid #22c55e;
    }

    .skill-tag.inactive {
        opacity: 0.5;
        background: #f8f8f8;
    }

    .skill-tag-content {
        flex: 1;
    }

    .skill-tag-actions {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-left: 4px;
    }

    .skill-tag .btn-edit-item {
        padding: 4px;
    }

    .skill-tag .btn-edit-item svg {
        width: 14px;
        height: 14px;
    }

    .skill-tag .toggle-switch {
        width: 32px;
        height: 18px;
    }

    .skill-tag .toggle-slider:before {
        height: 12px;
        width: 12px;
    }

    .skill-tag .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(14px);
    }

    /* Interests/Hobbies grid styles */
    .interests-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 16px;
    }

    .interest-item {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 16px;
        transition: all 0.2s ease;
    }

    .interest-item:hover {
        border-color: var(--primary);
        background: var(--light);
        box-shadow: 0 2px 8px rgba(79, 70, 229, 0.1);
    }

    .interest-icon {
        width: 32px;
        height: 32px;
        min-width: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #ec4899, #f43f5e);
        border-radius: 8px;
        color: white;
    }

    .interest-icon svg {
        width: 18px;
        height: 18px;
    }

    .interest-content {
        flex: 1;
        font-size: 0.95rem;
        color: var(--dark);
        font-weight: 500;
    }

    .interest-actions {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .interest-item .toggle-switch {
        width: 36px;
        height: 20px;
    }

    .interest-item .toggle-slider:before {
        height: 14px;
        width: 14px;
    }

    .interest-item .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(16px);
    }

    .interests-source {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: var(--gray);
        padding-top: 12px;
        border-top: 1px solid var(--border);
    }

    .interests-source svg {
        color: var(--gray);
    }

    .tab-content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .item-count {
        font-size: 0.85rem;
        color: var(--gray);
    }

    /* Documents section styles */
    .documents-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
    }

    .document-category {
        background: var(--light);
        border-radius: 16px;
        padding: 24px;
        border: 1px solid var(--border);
    }

    .document-category-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
    }

    .document-category-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .document-category-icon.cv {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    .document-category-icon.lm {
        background: linear-gradient(135deg, #f59e0b, #ef4444);
    }

    .document-category-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .document-category-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0 0 4px 0;
    }

    .document-category-desc {
        font-size: 0.85rem;
        color: var(--gray);
        margin: 0;
    }

    .document-list {
        min-height: 80px;
        margin-bottom: 16px;
    }

    .document-empty {
        background: white;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        border: 2px dashed var(--border);
    }

    .document-empty p {
        color: var(--gray);
        margin: 0;
        font-size: 0.9rem;
    }

    .btn-add-document {
        width: 100%;
        background: white;
        color: var(--primary);
        padding: 12px 20px;
        border-radius: 12px;
        border: 1px solid var(--primary);
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-add-document:hover {
        background: var(--primary);
        color: white;
    }

    .btn-add-document:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Upload modal overlay */
    .upload-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .upload-modal.active {
        display: flex;
    }

    .upload-modal-content {
        background: white;
        border-radius: 24px;
        padding: 32px;
        max-width: 480px;
        width: 90%;
        position: relative;
    }

    .upload-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .upload-modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--dark);
        margin: 0;
    }

    .upload-modal-close {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        color: var(--gray);
        transition: color 0.2s;
    }

    .upload-modal-close:hover {
        color: var(--dark);
    }

    .upload-dropzone {
        border: 2px dashed var(--border);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .upload-dropzone:hover,
    .upload-dropzone.dragover {
        border-color: var(--primary);
        background: rgba(79, 70, 229, 0.05);
    }

    .upload-dropzone-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
        color: var(--primary);
    }

    .upload-dropzone-text {
        font-size: 1rem;
        color: var(--dark);
        margin-bottom: 8px;
    }

    .upload-dropzone-hint {
        font-size: 0.85rem;
        color: var(--gray);
    }

    .upload-progress {
        display: none;
        margin-top: 24px;
    }

    .upload-progress.active {
        display: block;
    }

    .upload-progress-bar {
        height: 8px;
        background: var(--border);
        border-radius: 4px;
        overflow: hidden;
    }

    .upload-progress-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        width: 0%;
        transition: width 0.3s ease;
    }

    .upload-progress-text {
        font-size: 0.85rem;
        color: var(--gray);
        margin-top: 8px;
        text-align: center;
    }

    .upload-result {
        display: none;
        margin-top: 24px;
        padding: 16px;
        border-radius: 12px;
        text-align: center;
    }

    .upload-result.success {
        display: block;
        background: #dcfce7;
        color: #166534;
    }

    .upload-result.error {
        display: block;
        background: #fef2f2;
        color: #dc2626;
    }

    /* Document item styles */
    .document-item {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }

    .document-item:hover {
        border-color: var(--primary);
    }

    .document-item-icon {
        width: 40px;
        height: 40px;
        background: var(--light);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .document-item-icon svg {
        width: 20px;
        height: 20px;
        color: var(--primary);
    }

    .document-item-info {
        flex: 1;
        min-width: 0;
    }

    .document-item-name {
        font-weight: 600;
        color: var(--dark);
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .document-item-meta {
        font-size: 0.8rem;
        color: var(--gray);
    }

    .document-item-status {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .document-item-status.completed {
        background: #dcfce7;
        color: #166534;
    }

    .document-item-status.processing {
        background: #fef3c7;
        color: #92400e;
    }

    .document-item-status.failed {
        background: #fef2f2;
        color: #dc2626;
    }

    .document-item-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-delete-cv {
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px;
        color: var(--gray);
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-delete-cv:hover {
        background: #fef2f2;
        color: #dc2626;
    }

    .btn-delete-cv svg {
        width: 18px;
        height: 18px;
    }

    /* Delete confirmation modal */
    .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        align-items: center;
        justify-content: center;
    }

    .confirm-modal.active {
        display: flex;
    }

    .confirm-modal-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        text-align: center;
    }

    .confirm-modal-icon {
        width: 48px;
        height: 48px;
        background: #fef2f2;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: #dc2626;
    }

    .confirm-modal-icon svg {
        width: 24px;
        height: 24px;
    }

    .confirm-modal-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 8px;
    }

    .confirm-modal-text {
        color: var(--gray);
        font-size: 0.9rem;
        margin-bottom: 20px;
    }

    .confirm-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .btn-cancel {
        padding: 10px 20px;
        border: 1px solid var(--border);
        background: white;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-cancel:hover {
        background: var(--light);
    }

    .btn-confirm-delete {
        padding: 10px 20px;
        border: none;
        background: #dc2626;
        color: white;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-confirm-delete:hover {
        background: #b91c1c;
    }

    .btn-confirm-delete:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    @media (max-width: 768px) {
        .documents-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Responsive breakpoints */
    @media (max-width: 992px) {
        .profile-layout {
            flex-direction: column;
        }
        .profile-sidebar {
            width: 100%;
        }
        .profile-card {
            position: static;
        }
        .form-grid {
            grid-template-columns: 1fr;
        }
        .form-group.full-width {
            grid-column: span 1;
        }
    }

    /* ============================================
       Chat & Achievements Styles
       ============================================ */

    .achievements-layout {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 24px;
        min-height: 500px;
        position: relative;
    }

    /* Expanded chat mode - covers the entire content-card including title */
    .achievements-layout.chat-expanded .chat-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 95vw;
        max-width: 1200px;
        height: 85vh;
        z-index: 1000;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .achievements-layout.chat-expanded .successes-sidebar {
        visibility: hidden;
    }

    /* Backdrop overlay when chat is expanded */
    .achievements-layout.chat-expanded::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    @media (max-width: 992px) {
        .achievements-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Chat Container */
    .chat-container {
        display: flex;
        flex-direction: column;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background: #fff;
        overflow: hidden;
    }

    .chat-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .chat-header-icon {
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-header-icon svg {
        width: 20px;
        height: 20px;
    }

    .chat-header-text {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .chat-header-title {
        font-weight: 600;
        font-size: 16px;
    }

    .chat-header-status {
        font-size: 12px;
        opacity: 0.9;
    }

    .chat-new-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: rgba(255,255,255,0.2);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: background 0.2s;
    }

    .chat-expand-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: rgba(255,255,255,0.2);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: background 0.2s;
    }

    .chat-expand-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .chat-expand-btn svg {
        width: 18px;
        height: 18px;
    }

    /* Toggle icon based on expanded state */
    .chat-expand-btn .expand-icon { display: block; }
    .chat-expand-btn .collapse-icon { display: none; }
    .chat-expanded .chat-expand-btn .expand-icon { display: none; }
    .chat-expanded .chat-expand-btn .collapse-icon { display: block; }

    .chat-new-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .chat-new-btn svg {
        width: 18px;
        height: 18px;
    }

    /* Chat Messages */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8fafc;
        min-height: 350px;
        max-height: 450px;
    }

    /* Welcome Screen */
    .chat-welcome {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px 20px;
        height: 100%;
    }

    .chat-welcome-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
    }

    .chat-welcome-icon svg {
        width: 32px;
        height: 32px;
        color: white;
    }

    .chat-welcome-title {
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 8px;
    }

    .chat-welcome-desc {
        color: #64748b;
        margin-bottom: 16px;
    }

    .chat-star-list {
        list-style: none;
        padding: 0;
        margin: 0 0 24px 0;
        text-align: left;
        background: #f1f5f9;
        padding: 16px 20px;
        border-radius: 8px;
    }

    .chat-star-list li {
        color: #475569;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .chat-star-list li:last-child {
        margin-bottom: 0;
    }

    .chat-star-list strong {
        color: #667eea;
    }

    .chat-start-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .chat-start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .chat-start-btn svg {
        width: 18px;
        height: 18px;
    }

    /* Message Bubbles */
    .chat-message {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
        animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-message.user {
        flex-direction: row-reverse;
    }

    .chat-message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .chat-message.assistant .chat-message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .chat-message-avatar svg {
        width: 16px;
        height: 16px;
    }

    .chat-message-content {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.5;
    }

    .chat-message.user .chat-message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .chat-message.assistant .chat-message-content {
        background: white;
        color: #1e293b;
        border: 1px solid #e2e8f0;
        border-bottom-left-radius: 4px;
    }

    /* Markdown styling in chat messages */
    .chat-message-content p {
        margin: 0 0 0.5em 0;
    }
    .chat-message-content p:last-child {
        margin-bottom: 0;
    }
    .chat-message-content strong {
        font-weight: 600;
    }
    .chat-message-content em {
        font-style: italic;
    }
    .chat-message-content ul, .chat-message-content ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
    }
    .chat-message-content li {
        margin: 0.25em 0;
    }
    .chat-message-content blockquote {
        margin: 0.5em 0;
        padding-left: 1em;
        border-left: 3px solid #e2e8f0;
        color: #64748b;
    }
    .chat-message-content code {
        background: #f1f5f9;
        padding: 0.1em 0.3em;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9em;
    }
    .chat-message-content pre {
        background: #f1f5f9;
        padding: 0.75em;
        border-radius: 8px;
        overflow-x: auto;
        margin: 0.5em 0;
    }
    .chat-message-content pre code {
        background: none;
        padding: 0;
    }
    .chat-message-content h1, .chat-message-content h2, .chat-message-content h3 {
        margin: 0.5em 0 0.25em 0;
        font-weight: 600;
    }
    .chat-message-content h1 { font-size: 1.2em; }
    .chat-message-content h2 { font-size: 1.1em; }
    .chat-message-content h3 { font-size: 1em; }

    /* Typing Indicator */
    .chat-typing {
        display: flex;
        gap: 4px;
        padding: 8px 0;
    }

    .chat-typing span {
        width: 8px;
        height: 8px;
        background: #94a3b8;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite;
    }

    .chat-typing span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .chat-typing span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typingBounce {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-4px);
        }
    }

    /* Chat Input */
    .chat-input-container {
        display: flex;
        gap: 12px;
        padding: 16px 20px;
        border-top: 1px solid #e2e8f0;
        background: white;
    }

    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 24px;
        font-size: 14px;
        resize: none;
        outline: none;
        transition: border-color 0.2s;
        font-family: inherit;
    }

    .chat-input:focus {
        border-color: #667eea;
    }

    .chat-send-btn {
        width: 44px;
        height: 44px;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: transform 0.2s, opacity 0.2s;
    }

    .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .chat-send-btn:not(:disabled):hover {
        transform: scale(1.05);
    }

    .chat-send-btn svg {
        width: 18px;
        height: 18px;
    }

    /* Successes Sidebar */
    .successes-sidebar {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background: #fff;
        overflow: hidden;
    }

    .successes-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
    }

    .successes-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }

    .successes-count {
        background: #667eea;
        color: white;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 12px;
    }

    .successes-list {
        padding: 16px;
        max-height: 400px;
        overflow-y: auto;
    }

    .successes-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px 20px;
        color: #94a3b8;
    }

    .successes-empty svg {
        width: 48px;
        height: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .successes-empty p {
        font-size: 14px;
        margin: 0;
    }

    /* Success Card */
    .success-card {
        padding: 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 12px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .success-card:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .success-card:last-child {
        margin-bottom: 0;
    }

    .success-card-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
    }

    .success-card-title {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        flex: 1;
    }

    .success-card-badge {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: 500;
    }

    .success-card-badge.draft {
        background: #fef3c7;
        color: #92400e;
    }

    .success-card-badge.complete {
        background: #d1fae5;
        color: #065f46;
    }

    .success-card-progress {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #64748b;
    }

    .success-card-progress-bar {
        flex: 1;
        height: 4px;
        background: #e2e8f0;
        border-radius: 2px;
        overflow: hidden;
    }

    .success-card-progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 2px;
        transition: width 0.3s;
    }

    .success-card-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e2e8f0;
    }

    .success-card-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: #64748b;
    }

    .success-card-toggle .toggle-switch {
        width: 32px;
        height: 18px;
    }

    .success-card-toggle .toggle-slider:before {
        height: 12px;
        width: 12px;
    }

    .success-card-toggle .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(14px);
    }

    .success-card-buttons {
        display: flex;
        gap: 8px;
    }

    .success-card-btn {
        background: none;
        border: none;
        padding: 6px;
        cursor: pointer;
        border-radius: 6px;
        transition: background 0.2s, color 0.2s;
        color: #64748b;
    }

    .success-card-btn:hover {
        background: #f1f5f9;
        color: #334155;
    }

    .success-card-btn.delete:hover {
        background: #fef2f2;
        color: #dc2626;
    }

    .success-card-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Pitch-specific styles */
    .chat-welcome-note {
        color: #94a3b8;
        font-size: 13px;
        font-style: italic;
        margin-bottom: 16px;
    }

    .pitch-list strong {
        color: #8b5cf6;
    }

    .pitch-card-info {
        display: flex;
        gap: 12px;
        margin-bottom: 8px;
    }

    .pitch-word-count {
        font-size: 12px;
        color: #64748b;
        background: #f1f5f9;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .pitches-sidebar .successes-count {
        background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
    }

    .pitch-card:hover {
        border-color: #8b5cf6;
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-layout">
    <!-- Profile sidebar with photo and navigation -->
    <aside class="profile-sidebar">
        <div class="profile-card">
            <div class="profile-header">
                <div class="photo-container">
                    <div class="profile-photo">
                        {% if user.photo %}
                            <img src="{{ user.photo.url }}" alt="Photo de profil">
                        {% else %}
                            {{ user.first_name|first|default:user.email|first|upper }}
                        {% endif %}
                    </div>
                    <button type="button" class="photo-upload-btn" title="Changer la photo" onclick="openPhotoModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
                <div class="profile-name">{{ user.first_name }} {{ user.last_name }}</div>
                <div class="profile-email">{{ user.email }}</div>
            </div>

            <!-- Candidate profile selector -->
            <div class="candidate-profile-selector">
                <label>Profil de candidature</label>
                <div class="candidate-profile-row">
                    <select class="candidate-profile-select" id="candidateProfileSelect" onchange="switchCandidateProfile(this.value)">
                        {% for profile in candidate_profiles %}
                            <option value="{{ profile.id }}" data-description="{{ profile.description|default:'' }}" {% if profile.id == current_profile.id %}selected{% endif %}>
                                {{ profile.title }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="button" class="profile-action-btn" onclick="openProfileModal('create')" title="Nouveau profil">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                    <button type="button" class="profile-action-btn" onclick="openProfileModal('edit')" title="Modifier le profil">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                    <button type="button" class="profile-action-btn danger" onclick="deleteCandidateProfile()" title="Supprimer le profil">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <nav class="profile-menu">
                <a href="#documents" class="menu-item active" data-section="documents">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
                    </svg>
                    Mes documents
                </a>
                <a href="#personal" class="menu-item" data-section="personal">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Donnees personnelles
                </a>
                <a href="#parcours" class="menu-item" data-section="parcours">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Parcours professionnel
                </a>
                <a href="#hobbies" class="menu-item" data-section="hobbies">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Hobbies & personnel
                </a>
                <a href="#achievements" class="menu-item" data-section="achievements">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                    </svg>
                    Succes professionnels
                </a>
                <a href="#pitch" class="menu-item" data-section="pitch">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                    Mon pitch 30s/3min
                </a>

            </nav>
        </div>
    </aside>

    <!-- Main content area -->
    <main class="profile-content">
        <!-- Section: Personal data -->
        <section id="personal" class="content-section" style="display: none;">
            <div class="content-card">
                <div class="content-header">
                    <div>
                        <h2 class="content-title">Donnees personnelles</h2>
                        <p class="content-subtitle">Gerez vos informations de profil et preferences</p>
                    </div>
                </div>

                <form method="post" id="personal-form">
                    {% csrf_token %}

                    <!-- Basic info section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Informations de base</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_first_name" class="form-label">Prenom</label>
                                {{ form.first_name }}
                            </div>
                            <div class="form-group">
                                <label for="id_last_name" class="form-label">Nom</label>
                                {{ form.last_name }}
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" value="{{ user.email }}" disabled>
                                <small class="form-hint">Modifiable dans les parametres du compte</small>
                            </div>
                            <div class="form-group">
                                <label for="id_phone" class="form-label">Telephone</label>
                                {{ form.phone }}
                            </div>
                            <div class="form-group full-width">
                                <label for="id_location" class="form-label">Localisation</label>
                                {{ form.location }}
                                <small class="form-hint">Ex: Paris, Lyon, Nantes...</small>
                            </div>
                        </div>
                    </div>

                    <!-- Social links section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Liens professionnels</h3>
                        <div id="social-links-container">
                            {% for link in social_links %}
                            <div class="social-link-row" data-link-id="{{ link.id }}">
                                <span class="link-type-badge">{{ link.get_link_type_display }}</span>
                                <a href="{{ link.url }}" target="_blank" class="link-url">{{ link.url }}</a>
                                <button type="button" class="btn-delete-link" onclick="deleteSocialLink({{ link.id }})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            {% empty %}
                            <p class="empty-links-message" id="empty-links-message">Aucun lien ajoute</p>
                            {% endfor %}
                        </div>
                        <div class="add-link-form">
                            <select id="new-link-type" class="form-control link-type-select">
                                {% for value, label in social_link_types %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <input type="url" id="new-link-url" class="form-control" placeholder="https://...">
                            <button type="button" class="btn-add-link" onclick="addSocialLink()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Ajouter
                            </button>
                        </div>
                    </div>

                    <!-- Professional preferences section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Preferences professionnelles</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_seniority" class="form-label">Seniorite</label>
                                {{ form.seniority }}
                            </div>
                            <div class="form-group">
                                <label for="id_availability" class="form-label">Disponibilite</label>
                                {{ form.availability }}
                            </div>
                            <div class="form-group">
                                <label for="id_remote_preference" class="form-label">Preference teletravail</label>
                                {{ form.remote_preference }}
                            </div>
                            <div class="form-group">
                                <label for="id_mobility" class="form-label">Mobilite geographique</label>
                                {{ form.mobility }}
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Type de contrat recherche</label>
                                <div class="contract-checkboxes">
                                    {% for choice in form.contract_types %}
                                    <label class="contract-checkbox-label">
                                        {{ choice.tag }}
                                        <span>{{ choice.choice_label }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Salary section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Pretentions salariales</h3>
                        <div class="salary-slider-container">
                            <div class="salary-display">
                                <span class="salary-label">Fourchette:</span>
                                <span class="salary-value" id="salary-display-value">
                                    {% if user.salary_min and user.salary_max %}
                                        {{ user.salary_min }}k - {{ user.salary_max }}k brut/an
                                    {% else %}
                                        Non defini
                                    {% endif %}
                                </span>
                            </div>
                            <div class="salary-slider-wrapper">
                                <input type="range" id="salary-slider-min" class="salary-slider" min="20" max="150" value="{{ user.salary_min|default:40 }}" step="5">
                                <input type="range" id="salary-slider-max" class="salary-slider" min="20" max="150" value="{{ user.salary_max|default:60 }}" step="5">
                                <div class="slider-track"></div>
                                <div class="slider-range" id="slider-range"></div>
                            </div>
                            <div class="salary-bounds">
                                <span>20k</span>
                                <span>150k</span>
                            </div>
                            <!-- Hidden inputs for form submission -->
                            <input type="hidden" name="salary_min" id="id_salary_min" value="{{ user.salary_min|default:'' }}">
                            <input type="hidden" name="salary_max" id="id_salary_max" value="{{ user.salary_max|default:'' }}">
                        </div>
                    </div>

                    <!-- Personal notes section -->
                    <div class="form-section">
                        <h3 class="form-section-title">Notes personnelles</h3>
                        <div class="form-group full-width">
                            {{ form.personal_notes }}
                            <small class="form-hint">Informations complementaires que vous souhaitez partager</small>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn-save">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Section: Career path -->
        <section id="parcours" class="content-section" style="display: none;">
            <div class="content-card">
                <div class="content-header">
                    <div>
                        <h2 class="content-title">Parcours professionnel</h2>
                        <p class="content-subtitle">Gerez vos experiences, competences et formations</p>
                    </div>
                </div>

                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button class="tab-btn active" data-tab="experiences">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            Experiences
                        </button>
                        <button class="tab-btn" data-tab="competences">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            Competences
                        </button>
                        <button class="tab-btn" data-tab="formations">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" />
                            </svg>
                            Formations
                        </button>
                    </div>

                    <!-- Tab: Work experiences -->
                    <div id="tab-experiences" class="tab-content active">
                        {% if experiences %}
                        <div class="tab-content-header">
                            <span class="item-count">{{ experiences|length }} experience{{ experiences|length|pluralize }}</span>
                            <button class="btn-add">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Ajouter
                            </button>
                        </div>
                        <div class="extracted-items">
                            {% for exp in experiences %}
                            <div class="extracted-item" data-line-id="{{ exp.id }}">
                                {% if exp.entity or exp.position or exp.dates %}
                                <div class="extracted-item-header">
                                    <span class="item-entity">{{ exp.entity|default:"" }}</span>
                                    {% if exp.dates %}<span class="item-dates">{{ exp.dates }}</span>{% endif %}
                                    {% if exp.position %}<span class="item-position">{{ exp.position }}</span>{% endif %}
                                </div>
                                <div class="extracted-item-content">{{ exp.description|default:exp.content }}</div>
                                {% else %}
                                <div class="extracted-item-content">{{ exp.content }}</div>
                                {% endif %}
                                <div class="extracted-item-footer">
                                    <div class="extracted-item-source">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        {{ exp.source_cv.original_filename }}
                                    </div>
                                    <div class="extracted-item-actions">
                                        <button class="btn-edit-item" data-line-id="{{ exp.id }}" title="Modifier">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <label class="toggle-switch" title="Inclure dans ce profil">
                                            <input type="checkbox" class="toggle-profile-item" data-line-id="{{ exp.id }}" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="placeholder-section">
                            <div class="placeholder-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <h3 class="placeholder-title">Aucune experience ajoutee</h3>
                            <p class="placeholder-desc">Ajoutez vos experiences professionnelles ou importez un CV pour les extraire automatiquement</p>
                            <button class="btn-add">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Ajouter une experience
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Tab: Skills -->
                    <div id="tab-competences" class="tab-content">
                        {% if skills_hard or skills_soft %}
                        <div class="tab-content-header">
                            <span class="item-count">{{ skills_hard|length|add:skills_soft|length }} competence{{ skills_hard|length|add:skills_soft|length|pluralize }}</span>
                            <button class="btn-add">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Ajouter
                            </button>
                        </div>

                        {% if skills_hard %}
                        <div class="skills-section">
                            <h4 class="skills-section-title">Competences techniques</h4>
                            <div class="skills-grid">
                                {% for skill in skills_hard %}
                                <div class="skill-tag hard" data-line-id="{{ skill.id }}">
                                    <span class="skill-tag-content">{{ skill.content }}</span>
                                    <div class="skill-tag-actions">
                                        <button class="btn-edit-item" data-line-id="{{ skill.id }}" title="Modifier">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <label class="toggle-switch" title="Inclure dans ce profil">
                                            <input type="checkbox" class="toggle-profile-item" data-line-id="{{ skill.id }}" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if skills_soft %}
                        <div class="skills-section">
                            <h4 class="skills-section-title">Soft skills</h4>
                            <div class="skills-grid">
                                {% for skill in skills_soft %}
                                <div class="skill-tag soft" data-line-id="{{ skill.id }}">
                                    <span class="skill-tag-content">{{ skill.content }}</span>
                                    <div class="skill-tag-actions">
                                        <button class="btn-edit-item" data-line-id="{{ skill.id }}" title="Modifier">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </button>
                                        <label class="toggle-switch" title="Inclure dans ce profil">
                                            <input type="checkbox" class="toggle-profile-item" data-line-id="{{ skill.id }}" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% else %}
                        <div class="placeholder-section">
                            <div class="placeholder-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                </svg>
                            </div>
                            <h3 class="placeholder-title">Aucune competence ajoutee</h3>
                            <p class="placeholder-desc">Ajoutez vos competences techniques et soft skills</p>
                            <button class="btn-add">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Ajouter une competence
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Tab: Education -->
                    <div id="tab-formations" class="tab-content">
                        {% if educations or certifications %}
                        <div class="tab-content-header">
                            <span class="item-count">{{ educations|length|add:certifications|length }} formation{{ educations|length|add:certifications|length|pluralize }}</span>
                            <button class="btn-add">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Ajouter
                            </button>
                        </div>

                        {% if educations %}
                        <div class="skills-section">
                            <h4 class="skills-section-title">Diplomes</h4>
                            <div class="extracted-items">
                                {% for edu in educations %}
                                <div class="extracted-item" data-line-id="{{ edu.id }}">
                                    {% if edu.entity or edu.position or edu.dates %}
                                    <div class="extracted-item-header">
                                        <span class="item-entity">{{ edu.entity|default:"" }}</span>
                                        {% if edu.dates %}<span class="item-dates">{{ edu.dates }}</span>{% endif %}
                                        {% if edu.position %}<span class="item-position">{{ edu.position }}</span>{% endif %}
                                    </div>
                                    <div class="extracted-item-content">{{ edu.description|default:edu.content }}</div>
                                    {% else %}
                                    <div class="extracted-item-content">{{ edu.content }}</div>
                                    {% endif %}
                                    <div class="extracted-item-footer">
                                        <div class="extracted-item-source">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            {{ edu.source_cv.original_filename }}
                                        </div>
                                        <div class="extracted-item-actions">
                                            <button class="btn-edit-item" data-line-id="{{ edu.id }}" title="Modifier">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                            </button>
                                            <label class="toggle-switch" title="Inclure dans ce profil">
                                                <input type="checkbox" class="toggle-profile-item" data-line-id="{{ edu.id }}" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if certifications %}
                        <div class="skills-section">
                            <h4 class="skills-section-title">Certifications</h4>
                            <div class="extracted-items">
                                {% for cert in certifications %}
                                <div class="extracted-item" data-line-id="{{ cert.id }}">
                                    <div class="extracted-item-content">{{ cert.content }}</div>
                                    <div class="extracted-item-footer">
                                        <div class="extracted-item-source">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            {{ cert.source_cv.original_filename }}
                                        </div>
                                        <div class="extracted-item-actions">
                                            <button class="btn-edit-item" data-line-id="{{ cert.id }}" title="Modifier">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                </svg>
                                            </button>
                                            <label class="toggle-switch" title="Inclure dans ce profil">
                                                <input type="checkbox" class="toggle-profile-item" data-line-id="{{ cert.id }}" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% else %}
                        <div class="placeholder-section">
                            <div class="placeholder-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" />
                                </svg>
                            </div>
                            <h3 class="placeholder-title">Aucune formation ajoutee</h3>
                            <p class="placeholder-desc">Ajoutez vos diplomes et certifications</p>
                            <button class="btn-add">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Ajouter une formation
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Elevator pitch with AI chatbot -->
        <section id="pitch" class="content-section" style="display: none;">
            <div class="content-card">
                <div class="content-header">
                    <div>
                        <h2 class="content-title">Mon pitch</h2>
                        <p class="content-subtitle">Creez vos pitchs 30 secondes et 3 minutes avec notre coach IA</p>
                    </div>
                </div>

                <div class="achievements-layout">
                    <!-- Left: Chat interface -->
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="chat-header-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                </svg>
                            </div>
                            <div class="chat-header-text">
                                <span class="chat-header-title">Coach Pitch</span>
                                <span class="chat-header-status" id="pitch-chat-status">Pret a vous accompagner</span>
                            </div>
                            <button class="chat-expand-btn" id="pitch-chat-expand-btn" title="Agrandir/Reduire">
                                <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                </svg>
                                <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" />
                                </svg>
                            </button>
                            <button class="chat-new-btn" id="pitch-chat-new-btn" title="Nouvelle conversation">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>

                        <div class="chat-messages" id="pitch-chat-messages">
                            <!-- Welcome message -->
                            <div class="chat-welcome pitch-welcome">
                                <div class="chat-welcome-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                    </svg>
                                </div>
                                <h3 class="chat-welcome-title">Creez votre pitch</h3>
                                <p class="chat-welcome-desc">Je vais vous aider a creer deux pitchs percutants :</p>
                                <ul class="chat-star-list pitch-list">
                                    <li><strong>30s</strong> - Elevator pitch pour captiver rapidement</li>
                                    <li><strong>3min</strong> - Pitch detaille pour les entretiens</li>
                                </ul>
                                <p class="chat-welcome-note">Vos succes professionnels seront utilises pour enrichir votre pitch.</p>
                                <button class="chat-start-btn pitch-start-btn" id="pitch-chat-start-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                    Demarrer la conversation
                                </button>
                            </div>
                        </div>

                        <div class="chat-input-container" id="pitch-chat-input-container" style="display: none;">
                            <textarea
                                class="chat-input"
                                id="pitch-chat-input"
                                placeholder="Ecrivez votre message..."
                                rows="1"
                            ></textarea>
                            <button class="chat-send-btn" id="pitch-chat-send-btn" disabled style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Right: Pitches list -->
                    <div class="successes-sidebar pitches-sidebar">
                        <div class="successes-header">
                            <h3 class="successes-title">Mes pitchs</h3>
                            <span class="successes-count" id="pitches-count">0</span>
                        </div>
                        <div class="successes-list" id="pitches-list">
                            <!-- Pitches will be loaded here -->
                            <div class="successes-empty" id="pitches-empty">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                </svg>
                                <p>Vos pitchs apparaitront ici</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Professional achievements with AI chatbot -->
        <section id="achievements" class="content-section" style="display: none;">
            <div class="content-card">
                <div class="content-header">
                    <div>
                        <h2 class="content-title">Succes professionnels</h2>
                        <p class="content-subtitle">Laissez-vous guider par notre consultant IA pour formaliser vos succes avec la methode STAR</p>
                    </div>
                </div>

                <div class="achievements-layout">
                    <!-- Left: Chat interface -->
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="chat-header-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                            </div>
                            <div class="chat-header-text">
                                <span class="chat-header-title">Coach STAR</span>
                                <span class="chat-header-status" id="chat-status">Pret a vous accompagner</span>
                            </div>
                            <button class="chat-expand-btn" id="chat-expand-btn" title="Agrandir/Reduire">
                                <svg class="expand-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                </svg>
                                <svg class="collapse-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.75 3.75M9 15v4.5M9 15H4.5M9 15l-5.25 5.25M15 9h4.5M15 9V4.5M15 9l5.25-5.25M15 15h4.5M15 15v4.5m0-4.5l5.25 5.25" />
                                </svg>
                            </button>
                            <button class="chat-new-btn" id="chat-new-btn" title="Nouvelle conversation">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>

                        <div class="chat-messages" id="chat-messages">
                            <!-- Welcome message -->
                            <div class="chat-welcome">
                                <div class="chat-welcome-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                                    </svg>
                                </div>
                                <h3 class="chat-welcome-title">Methode STAR</h3>
                                <p class="chat-welcome-desc">Je vais vous guider pour structurer vos realisations professionnelles :</p>
                                <ul class="chat-star-list">
                                    <li><strong>S</strong>ituation - Le contexte</li>
                                    <li><strong>T</strong>ache - Votre mission</li>
                                    <li><strong>A</strong>ction - Ce que vous avez fait</li>
                                    <li><strong>R</strong>esultat - L'impact mesurable</li>
                                </ul>
                                <button class="chat-start-btn" id="chat-start-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                    Demarrer la conversation
                                </button>
                            </div>
                        </div>

                        <div class="chat-input-container" id="chat-input-container" style="display: none;">
                            <textarea
                                class="chat-input"
                                id="chat-input"
                                placeholder="Ecrivez votre message..."
                                rows="1"
                            ></textarea>
                            <button class="chat-send-btn" id="chat-send-btn" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Right: Successes list -->
                    <div class="successes-sidebar">
                        <div class="successes-header">
                            <h3 class="successes-title">Mes succes</h3>
                            <span class="successes-count" id="successes-count">0</span>
                        </div>
                        <div class="successes-list" id="successes-list">
                            <!-- Successes will be loaded here -->
                            <div class="successes-empty" id="successes-empty">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                                </svg>
                                <p>Vos succes formalises apparaitront ici</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section: Hobbies and personal interests -->
        <section id="hobbies" class="content-section" style="display: none;">
            <div class="content-card">
                <div class="content-header">
                    <div>
                        <h2 class="content-title">Hobbies & personnel</h2>
                        <p class="content-subtitle">Partagez vos centres d'interet et accomplissements personnels</p>
                    </div>
                </div>

                {% if interests %}
                <div class="tab-content-header">
                    <span class="item-count">{{ interests|length }} centre{{ interests|length|pluralize }} d'interet</span>
                    <button class="btn-add">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Ajouter
                    </button>
                </div>
                <div class="interests-grid">
                    {% for interest in interests %}
                    <div class="interest-item" data-line-id="{{ interest.id }}">
                        <div class="interest-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </div>
                        <span class="interest-content">{{ interest.content }}</span>
                        <div class="interest-actions">
                            <label class="toggle-switch" title="Inclure dans ce profil">
                                <input type="checkbox" class="toggle-profile-item" data-line-id="{{ interest.id }}" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="interests-source">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Centres d'interet extraits de vos CV
                </div>
                {% else %}
                <div class="placeholder-section">
                    <div class="placeholder-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 class="placeholder-title">Aucun centre d'interet ajoute</h3>
                    <p class="placeholder-desc">Importez un CV contenant vos hobbies ou ajoutez-les manuellement</p>
                    <button class="btn-add">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Ajouter un centre d'interet
                    </button>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Section: My documents (CV and cover letters) -->
        <section id="documents" class="content-section">
            <div class="content-card">
                <div class="content-header">
                    <div>
                        <h2 class="content-title">Mes documents</h2>
                        <p class="content-subtitle">Importez et gerez vos CV et lettres de motivation</p>
                    </div>
                </div>

                <div class="documents-grid">
                    <!-- CV upload section -->
                    <div class="document-category">
                        <div class="document-category-header">
                            <div class="document-category-icon cv">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="document-category-title">Curriculum Vitae</h3>
                                <p class="document-category-desc">Importez vos CV pour le matching automatique</p>
                            </div>
                        </div>
                        <div class="document-list" id="cv-list">
                            {% for cv in user_cvs %}
                            <div class="document-item" data-cv-id="{{ cv.id }}" data-task-id="{{ cv.task_id|default:'' }}" data-status="{{ cv.extraction_status }}">
                                <div class="document-item-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                <div class="document-item-info">
                                    <div class="document-item-name">{{ cv.original_filename }}</div>
                                    <div class="document-item-meta">{{ cv.uploaded_at|date:"d/m/Y H:i" }}</div>
                                </div>
                                <div class="document-item-actions">
                                    <span class="document-item-status {{ cv.extraction_status }}">
                                        {% if cv.extraction_status == 'completed' %}Extrait
                                        {% elif cv.extraction_status == 'processing' %}En cours...
                                        {% elif cv.extraction_status == 'failed' %}Echec
                                        {% else %}En attente{% endif %}
                                    </span>
                                    <button class="btn-delete-cv" data-cv-id="{{ cv.id }}" data-cv-name="{{ cv.original_filename }}" title="Supprimer">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            {% empty %}
                            <div class="document-empty">
                                <p>Aucun CV importe</p>
                            </div>
                            {% endfor %}
                        </div>
                        <button class="btn-add-document" id="btn-upload-cv">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Importer un CV
                        </button>
                    </div>

                    <!-- Cover letters section -->
                    <div class="document-category">
                        <div class="document-category-header">
                            <div class="document-category-icon lm">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="document-category-title">Lettres de motivation</h3>
                                <p class="document-category-desc">Gerez vos modeles de lettres</p>
                            </div>
                        </div>
                        <div class="document-list">
                            <div class="document-empty">
                                <p>Aucune lettre importee</p>
                            </div>
                        </div>
                        <button class="btn-add-document">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Importer une lettre
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- CV Upload Modal -->
<div class="upload-modal" id="cv-upload-modal">
    <div class="upload-modal-content">
        <div class="upload-modal-header">
            <h3 class="upload-modal-title">Importer un CV</h3>
            <button class="upload-modal-close" id="close-upload-modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="cv-upload-form" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" id="cv-file-input" name="file" accept=".pdf,.docx" style="display: none;">

            <div class="upload-dropzone" id="upload-dropzone">
                <svg class="upload-dropzone-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p class="upload-dropzone-text">Glissez votre CV ici ou cliquez pour parcourir</p>
                <p class="upload-dropzone-hint">Formats acceptes : PDF, DOCX (max 10 Mo)</p>
            </div>

            <div class="upload-progress" id="upload-progress">
                <div class="upload-progress-bar">
                    <div class="upload-progress-fill" id="upload-progress-fill"></div>
                </div>
                <p class="upload-progress-text" id="upload-progress-text">Extraction en cours...</p>
            </div>

            <div class="upload-result" id="upload-result"></div>
        </form>
    </div>
</div>

<!-- CV Delete Confirmation Modal -->
<div class="confirm-modal" id="cv-delete-modal">
    <div class="confirm-modal-content">
        <div class="confirm-modal-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </div>
        <h3 class="confirm-modal-title">Supprimer ce CV ?</h3>
        <p class="confirm-modal-text" id="delete-cv-name">Cette action supprimera egalement toutes les donnees extraites de ce CV.</p>
        <div class="confirm-modal-actions">
            <button class="btn-cancel" id="cancel-delete-cv">Annuler</button>
            <button class="btn-confirm-delete" id="confirm-delete-cv">Supprimer</button>
        </div>
    </div>
</div>

<!-- Candidate Profile Modal -->
<div class="profile-modal-overlay" id="profileModal">
    <div class="profile-modal">
        <h3 id="profileModalTitle">Nouveau profil</h3>
        <div class="profile-modal-field">
            <label for="profileTitleInput">Titre du profil</label>
            <input type="text" id="profileTitleInput" placeholder="Ex: Data Scientist, Tech Lead...">
        </div>
        <div class="profile-modal-field">
            <label for="profileDescInput">Description (optionnel)</label>
            <textarea id="profileDescInput" placeholder="Description du type de poste vise..."></textarea>
        </div>
        <div class="profile-modal-actions">
            <button type="button" class="profile-modal-btn cancel" onclick="closeProfileModal()">Annuler</button>
            <button type="button" class="profile-modal-btn confirm" onclick="saveProfile()">Enregistrer</button>
        </div>
    </div>
</div>

<!-- Success Created Modal -->
<div class="profile-modal-overlay" id="successModal">
    <div class="profile-modal" style="text-align: center;">
        <div style="margin-bottom: 20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="#22c55e" style="margin: 0 auto;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <h3 style="color: #22c55e; margin-bottom: 12px;">Succes ajoute !</h3>
        <p style="color: #6b7280; margin-bottom: 24px;">Ton succes professionnel a bien ete ajoute a ton profil.</p>
        <button type="button" class="profile-modal-btn confirm" onclick="closeSuccessModal()" style="width: 100%;">OK</button>
    </div>
</div>

<!-- Success Delete Confirmation Modal -->
<div class="profile-modal-overlay" id="successDeleteModal">
    <div class="profile-modal" style="text-align: center;">
        <div style="margin-bottom: 20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="#dc2626" style="margin: 0 auto;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </div>
        <h3 style="color: #dc2626; margin-bottom: 12px;">Supprimer ce succes ?</h3>
        <p style="color: #6b7280; margin-bottom: 24px;" id="successDeleteTitle">Cette action est irreversible.</p>
        <div class="profile-modal-actions" style="justify-content: center;">
            <button type="button" class="profile-modal-btn cancel" onclick="closeSuccessDeleteModal()">Annuler</button>
            <button type="button" class="profile-modal-btn confirm" style="background: #dc2626;" onclick="confirmDeleteSuccess()">Supprimer</button>
        </div>
    </div>
</div>

<!-- Success View Modal -->
<div class="profile-modal-overlay" id="successViewModal">
    <div class="profile-modal" style="max-width: 900px; width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #1e293b;" id="successViewTitle">Titre du succes</h3>
            <button type="button" onclick="closeSuccessViewModal()" style="background: none; border: none; cursor: pointer; padding: 4px; color: #64748b;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div style="text-align: left;">
            <div style="margin-bottom: 16px;">
                <h4 style="font-size: 14px; font-weight: 600; color: #667eea; margin: 0 0 8px;">Situation</h4>
                <p style="margin: 0; color: #374151; font-size: 14px; line-height: 1.6;" id="successViewSituation"></p>
            </div>
            <div style="margin-bottom: 16px;">
                <h4 style="font-size: 14px; font-weight: 600; color: #667eea; margin: 0 0 8px;">Tache</h4>
                <p style="margin: 0; color: #374151; font-size: 14px; line-height: 1.6;" id="successViewTask"></p>
            </div>
            <div style="margin-bottom: 16px;">
                <h4 style="font-size: 14px; font-weight: 600; color: #667eea; margin: 0 0 8px;">Actions</h4>
                <p style="margin: 0; color: #374151; font-size: 14px; line-height: 1.6;" id="successViewAction"></p>
            </div>
            <div style="margin-bottom: 16px;">
                <h4 style="font-size: 14px; font-weight: 600; color: #667eea; margin: 0 0 8px;">Resultats</h4>
                <p style="margin: 0; color: #374151; font-size: 14px; line-height: 1.6;" id="successViewResult"></p>
            </div>
            <div>
                <h4 style="font-size: 14px; font-weight: 600; color: #667eea; margin: 0 0 8px;">Competences demontrees</h4>
                <div id="successViewSkills" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
            </div>
        </div>
        <div class="profile-modal-actions" style="margin-top: 24px; justify-content: center; gap: 12px;">
            <button type="button" class="profile-modal-btn cancel" onclick="exportSuccessDocx()" style="display: flex; align-items: center; gap: 6px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Export DOCX
            </button>
            <button type="button" class="profile-modal-btn confirm" onclick="closeSuccessViewModal()">Fermer</button>
        </div>
    </div>
</div>

<!-- Photo Upload Modal -->
<div class="photo-modal-overlay" id="photoModal">
    <div class="photo-modal">
        <div class="photo-modal-header">
            <h3 id="photoModalTitle">Photo de profil</h3>
            <button type="button" class="photo-modal-close" onclick="closePhotoModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="photo-modal-body">
            <!-- Step 1: Current photo & upload zone -->
            <div id="photoStep1">
                <!-- Current photo preview -->
                <div class="photo-preview-container">
                    <div class="photo-preview" id="photoPreview">
                        {% if user.photo %}
                            <img src="{{ user.photo.url }}" alt="Photo de profil" id="previewImg">
                        {% else %}
                            <div class="photo-preview-placeholder" id="previewPlaceholder">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Upload zone -->
                <div class="photo-upload-zone" id="photoDropzone">
                    <input type="file" id="photoFileInput" accept="image/jpeg,image/png,image/webp" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="photo-upload-text">Cliquez ou glissez une photo ici</p>
                    <p class="photo-upload-hint">JPG, PNG ou WebP - Max 5 Mo</p>
                </div>
            </div>

            <!-- Step 2: Crop editor -->
            <div id="photoStep2" style="display: none;">
                <div class="photo-crop-container">
                    <img id="photoCropImage" src="" alt="Image to crop">
                </div>
                <div class="photo-crop-hint">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Faites glisser pour repositionner, utilisez la molette pour zoomer
                </div>
            </div>

            <!-- Progress bar -->
            <div class="photo-progress" id="photoProgress" style="display: none;">
                <div class="photo-progress-bar">
                    <div class="photo-progress-fill" id="photoProgressFill"></div>
                </div>
                <p class="photo-progress-text">Envoi en cours...</p>
            </div>
        </div>

        <!-- Footer Step 1 -->
        <div class="photo-modal-footer" id="photoFooter1">
            {% if user.photo %}
            <button type="button" class="photo-modal-btn delete" id="btnDeletePhoto" onclick="deletePhoto()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Supprimer
            </button>
            {% endif %}
            <button type="button" class="photo-modal-btn cancel" onclick="closePhotoModal()">Fermer</button>
        </div>

        <!-- Footer Step 2 (Crop) -->
        <div class="photo-modal-footer" id="photoFooter2" style="display: none;">
            <button type="button" class="photo-modal-btn cancel" onclick="cancelCrop()">Annuler</button>
            <button type="button" class="photo-modal-btn confirm" onclick="applyCrop()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Appliquer
            </button>
        </div>
    </div>
</div>

{{ profile_selections|json_script:"profile-selections-data" }}

<!-- Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<!-- Marked.js for Markdown rendering in chat -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>

<script>
// Current profile state
let currentProfileId = {{ current_profile.id }};
let profileSelections = JSON.parse(document.getElementById('profile-selections-data').textContent);
let profileModalMode = 'create'; // 'create' or 'edit'

// Photo cropper instance
let photoCropper = null;

// CSRF token helper
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// ============== Social Links Management ==============
function addSocialLink() {
    const linkType = document.getElementById('new-link-type').value;
    const url = document.getElementById('new-link-url').value;

    if (!url) {
        alert('Veuillez entrer une URL');
        return;
    }

    fetch('{% url "accounts:social_link_add" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({ link_type: linkType, url: url }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove empty message if present
            const emptyMsg = document.getElementById('empty-links-message');
            if (emptyMsg) emptyMsg.remove();

            // Add new link row
            const container = document.getElementById('social-links-container');
            const linkRow = document.createElement('div');
            linkRow.className = 'social-link-row';
            linkRow.setAttribute('data-link-id', data.link.id);
            linkRow.innerHTML = `
                <span class="link-type-badge">${data.link.link_type_display}</span>
                <a href="${data.link.url}" target="_blank" class="link-url">${data.link.url}</a>
                <button type="button" class="btn-delete-link" onclick="deleteSocialLink(${data.link.id})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;
            container.appendChild(linkRow);

            // Clear input
            document.getElementById('new-link-url').value = '';
        } else {
            alert(data.error || 'Erreur lors de l\'ajout du lien');
        }
    })
    .catch(error => {
        console.error('Error adding link:', error);
        alert('Erreur lors de l\'ajout du lien');
    });
}

function deleteSocialLink(linkId) {
    if (!confirm('Supprimer ce lien ?')) return;

    fetch(`/accounts/social-link/${linkId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the row
            const row = document.querySelector(`[data-link-id="${linkId}"]`);
            if (row) row.remove();

            // Show empty message if no links left
            const container = document.getElementById('social-links-container');
            if (container.children.length === 0) {
                const emptyMsg = document.createElement('p');
                emptyMsg.className = 'empty-links-message';
                emptyMsg.id = 'empty-links-message';
                emptyMsg.textContent = 'Aucun lien ajoute';
                container.appendChild(emptyMsg);
            }
        } else {
            alert(data.error || 'Erreur lors de la suppression');
        }
    })
    .catch(error => {
        console.error('Error deleting link:', error);
        alert('Erreur lors de la suppression');
    });
}

// ============== Salary Slider ==============
function initSalarySlider() {
    const sliderMin = document.getElementById('salary-slider-min');
    const sliderMax = document.getElementById('salary-slider-max');
    const sliderRange = document.getElementById('slider-range');
    const displayValue = document.getElementById('salary-display-value');
    const hiddenMin = document.getElementById('id_salary_min');
    const hiddenMax = document.getElementById('id_salary_max');

    if (!sliderMin || !sliderMax) return;

    function updateSlider() {
        let minVal = parseInt(sliderMin.value);
        let maxVal = parseInt(sliderMax.value);

        // Prevent crossover
        if (minVal > maxVal) {
            if (this === sliderMin) {
                minVal = maxVal;
                sliderMin.value = minVal;
            } else {
                maxVal = minVal;
                sliderMax.value = maxVal;
            }
        }

        // Update display
        displayValue.textContent = `${minVal}k - ${maxVal}k brut/an`;

        // Update hidden inputs
        hiddenMin.value = minVal;
        hiddenMax.value = maxVal;

        // Update range highlight
        const percent1 = ((minVal - 20) / (150 - 20)) * 100;
        const percent2 = ((maxVal - 20) / (150 - 20)) * 100;
        sliderRange.style.left = percent1 + '%';
        sliderRange.style.width = (percent2 - percent1) + '%';
    }

    sliderMin.addEventListener('input', updateSlider);
    sliderMax.addEventListener('input', updateSlider);

    // Initialize
    updateSlider.call(sliderMin);
}

// Initialize salary slider on page load
document.addEventListener('DOMContentLoaded', initSalarySlider);

// Switch candidate profile
function switchCandidateProfile(profileId) {
    fetch('{% url "accounts:profile_switch" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({ profile_id: parseInt(profileId) }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentProfileId = data.profile_id;
            // Load selections for new profile
            loadProfileSelections(profileId);
        } else {
            alert(data.error || 'Erreur lors du changement de profil');
        }
    })
    .catch(error => {
        console.error('Error switching profile:', error);
        alert('Erreur lors du changement de profil');
    });
}

// Load profile selections and update checkboxes
function loadProfileSelections(profileId) {
    fetch(`/accounts/candidate-profile/${profileId}/selections/`, {
        headers: { 'X-CSRFToken': getCsrfToken() },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            profileSelections = data.selections;
            updateCheckboxesFromSelections();
        }
    })
    .catch(error => console.error('Error loading selections:', error));
}

// Update all toggles based on current selections
function updateCheckboxesFromSelections() {
    document.querySelectorAll('.toggle-profile-item').forEach(toggle => {
        const lineId = parseInt(toggle.dataset.lineId);
        const isSelected = profileSelections[lineId] !== false; // Default to true
        toggle.checked = isSelected;
        updateItemVisual(lineId, isSelected);
    });
}

// Update visual state of an item
function updateItemVisual(lineId, isSelected) {
    const item = document.querySelector(`[data-line-id="${lineId}"]`);
    if (item) {
        if (isSelected) {
            item.classList.remove('deselected');
        } else {
            item.classList.add('deselected');
        }
    }
}

// Toggle profile item selection
function toggleProfileItem(lineId, toggle) {
    const isSelected = toggle.checked;
    fetch(`/accounts/candidate-profile/${currentProfileId}/item/${lineId}/toggle/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            profileSelections[lineId] = data.is_selected;
            updateItemVisual(lineId, data.is_selected);
            // Sync toggle state with server response
            toggle.checked = data.is_selected;
        } else {
            // Revert toggle on error
            toggle.checked = !isSelected;
            alert(data.error || 'Erreur');
        }
    })
    .catch(error => {
        console.error('Error toggling item:', error);
        toggle.checked = !isSelected;
    });
}

// Open profile modal
function openProfileModal(mode) {
    profileModalMode = mode;
    const modal = document.getElementById('profileModal');
    const titleEl = document.getElementById('profileModalTitle');
    const titleInput = document.getElementById('profileTitleInput');
    const descInput = document.getElementById('profileDescInput');

    if (mode === 'create') {
        titleEl.textContent = 'Nouveau profil';
        titleInput.value = '';
        descInput.value = '';
    } else {
        titleEl.textContent = 'Modifier le profil';
        const select = document.getElementById('candidateProfileSelect');
        const selectedOption = select.options[select.selectedIndex];
        titleInput.value = selectedOption.text;
        descInput.value = selectedOption.dataset.description || '';
    }

    modal.classList.add('show');
    titleInput.focus();
}

// Close profile modal
function closeProfileModal() {
    document.getElementById('profileModal').classList.remove('show');
}

// Close success modal
function closeSuccessModal() {
    document.getElementById('successModal').classList.remove('show');
}

// Show success modal
function showSuccessModal() {
    document.getElementById('successModal').classList.add('show');
}

// Close success delete modal
function closeSuccessDeleteModal() {
    document.getElementById('successDeleteModal').classList.remove('show');
}

// Close success view modal
function closeSuccessViewModal() {
    document.getElementById('successViewModal').classList.remove('show');
}

// Export success to DOCX
async function exportSuccessDocx() {
    const exportBtn = event.target.closest('button');
    const originalText = exportBtn.innerHTML;

    try {
        exportBtn.innerHTML = '<span style="display:flex;align-items:center;gap:6px;">Chargement...</span>';
        exportBtn.disabled = true;

        // Get the current success data from the modal
        const title = document.getElementById('successViewTitle').textContent;
        const situation = document.getElementById('successViewSituation').textContent;
        const task = document.getElementById('successViewTask').textContent;
        const action = document.getElementById('successViewAction').textContent;
        const result = document.getElementById('successViewResult').textContent;
        const skillsContainer = document.getElementById('successViewSkills');
        const skills = Array.from(skillsContainer.querySelectorAll('span')).map(s => s.textContent).filter(s => s !== 'Aucune competence');

        // Load docx library dynamically if not already loaded
        if (!window.docx) {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/docx@8.5.0/build/index.umd.js';
            document.head.appendChild(script);
            await new Promise((resolve, reject) => {
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load docx library'));
            });
        }

        const { Document, Packer, Paragraph, TextRun, HeadingLevel } = window.docx;

        // Create document
        const doc = new Document({
            sections: [{
                properties: {},
                children: [
                    new Paragraph({
                        text: title,
                        heading: HeadingLevel.HEADING_1,
                    }),
                    new Paragraph({ text: '' }),
                    new Paragraph({
                        children: [
                            new TextRun({ text: 'Situation', bold: true, color: '667eea' }),
                        ],
                    }),
                    new Paragraph({ text: situation }),
                    new Paragraph({ text: '' }),
                    new Paragraph({
                        children: [
                            new TextRun({ text: 'Tache', bold: true, color: '667eea' }),
                        ],
                    }),
                    new Paragraph({ text: task }),
                    new Paragraph({ text: '' }),
                    new Paragraph({
                        children: [
                            new TextRun({ text: 'Actions', bold: true, color: '667eea' }),
                        ],
                    }),
                    new Paragraph({ text: action }),
                    new Paragraph({ text: '' }),
                    new Paragraph({
                        children: [
                            new TextRun({ text: 'Resultats', bold: true, color: '667eea' }),
                        ],
                    }),
                    new Paragraph({ text: result }),
                    new Paragraph({ text: '' }),
                    new Paragraph({
                        children: [
                            new TextRun({ text: 'Competences demontrees', bold: true, color: '667eea' }),
                        ],
                    }),
                    new Paragraph({ text: skills.length > 0 ? skills.join(', ') : '-' }),
                ],
            }],
        });

        // Generate and download
        const blob = await Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `succes_${title.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '_')}.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        exportBtn.innerHTML = '<span style="display:flex;align-items:center;gap:6px;">Telecharge !</span>';
        setTimeout(() => {
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        }, 2000);
    } catch (error) {
        console.error('Export DOCX error:', error);
        alert('Erreur lors de l\'export: ' + error.message);
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
    }
}

// Confirm delete success - called from modal button
function confirmDeleteSuccess() {
    // Get the StarChatbot instance and call deleteSuccess
    if (window.starChatInstance && window.starChatInstance.successToDelete) {
        window.starChatInstance.deleteSuccess(window.starChatInstance.successToDelete);
        closeSuccessDeleteModal();
    }
}

// Save profile (create or update)
function saveProfile() {
    const title = document.getElementById('profileTitleInput').value.trim();
    const description = document.getElementById('profileDescInput').value.trim();

    if (!title) {
        alert('Le titre est requis');
        return;
    }

    const url = profileModalMode === 'create'
        ? '{% url "accounts:profile_create" %}'
        : `/accounts/candidate-profile/${currentProfileId}/update/`;

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({ title, description }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeProfileModal();
            // Reload page to update dropdown
            window.location.reload();
        } else {
            alert(data.error || 'Erreur');
        }
    })
    .catch(error => {
        console.error('Error saving profile:', error);
        alert('Erreur lors de la sauvegarde');
    });
}

// Delete candidate profile
function deleteCandidateProfile() {
    const select = document.getElementById('candidateProfileSelect');
    const profileTitle = select.options[select.selectedIndex].text;

    if (profileTitle === 'Complet') {
        alert('Le profil "Complet" ne peut pas etre supprime');
        return;
    }

    if (!confirm(`Supprimer le profil "${profileTitle}" ?`)) {
        return;
    }

    fetch(`/accounts/candidate-profile/${currentProfileId}/delete/`, {
        method: 'DELETE',
        headers: { 'X-CSRFToken': getCsrfToken() },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Erreur');
        }
    })
    .catch(error => {
        console.error('Error deleting profile:', error);
        alert('Erreur lors de la suppression');
    });
}

// Close modal when clicking outside
const profileModalEl = document.getElementById('profileModal');
if (profileModalEl) {
    profileModalEl.addEventListener('click', function(e) {
        if (e.target === this) {
            closeProfileModal();
        }
    });
}

// Initialize selections on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCheckboxesFromSelections();
});

document.addEventListener('DOMContentLoaded', function() {
    // Sidebar menu navigation
    const menuItems = document.querySelectorAll('.menu-item[data-section]');
    const sections = document.querySelectorAll('.content-section');

    // Function to show a specific section
    function showSection(sectionId) {
        // Update active menu item
        menuItems.forEach(m => m.classList.remove('active'));
        const activeItem = document.querySelector(`.menu-item[data-section="${sectionId}"]`);
        if (activeItem) activeItem.classList.add('active');

        // Display selected section
        sections.forEach(s => s.style.display = 'none');
        const section = document.getElementById(sectionId);
        if (section) section.style.display = 'block';

        // Update URL hash without scrolling
        history.replaceState(null, null, '#' + sectionId);
    }

    // Handle menu item clicks
    menuItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionId = this.getAttribute('data-section');
            showSection(sectionId);
        });
    });

    // On page load, check for hash in URL and show that section
    const hash = window.location.hash.substring(1);
    if (hash && document.getElementById(hash)) {
        showSection(hash);
    }

    // Tab navigation for career path section
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');

            // Update active tab button
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Display selected tab content
            tabContents.forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
        });
    });

    // CV Upload functionality
    const uploadModal = document.getElementById('cv-upload-modal');
    const uploadBtn = document.getElementById('btn-upload-cv');
    const closeBtn = document.getElementById('close-upload-modal');
    const dropzone = document.getElementById('upload-dropzone');
    const fileInput = document.getElementById('cv-file-input');
    const uploadForm = document.getElementById('cv-upload-form');
    const progressDiv = document.getElementById('upload-progress');
    const progressFill = document.getElementById('upload-progress-fill');
    const progressText = document.getElementById('upload-progress-text');
    const resultDiv = document.getElementById('upload-result');

    // Polling configuration
    const POLL_INTERVAL = 2000;  // 2 seconds
    const MAX_POLL_ATTEMPTS = 120;  // 4 minutes max
    let pollCount = 0;
    let pollTimer = null;

    // Open modal
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
            uploadModal.classList.add('active');
            resetUploadState();
        });
    }

    // Close modal
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            uploadModal.classList.remove('active');
            if (pollTimer) {
                clearTimeout(pollTimer);
                pollTimer = null;
            }
        });
    }

    // Close on outside click
    if (uploadModal) {
        uploadModal.addEventListener('click', function(e) {
            if (e.target === uploadModal) {
                uploadModal.classList.remove('active');
                if (pollTimer) {
                    clearTimeout(pollTimer);
                    pollTimer = null;
                }
            }
        });
    }

    // Click on dropzone opens file picker
    if (dropzone && fileInput) {
        dropzone.addEventListener('click', function() {
            fileInput.click();
        });

        // Drag and drop handlers
        dropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', function() {
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        // File input change
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFileUpload(this.files[0]);
            }
        });
    }

    function resetUploadState() {
        progressDiv.classList.remove('active');
        resultDiv.className = 'upload-result';
        resultDiv.textContent = '';
        progressFill.style.width = '0%';
        fileInput.value = '';
        dropzone.style.display = 'block';
        pollCount = 0;
        if (pollTimer) {
            clearTimeout(pollTimer);
            pollTimer = null;
        }
    }

    function handleFileUpload(file) {
        // Validate file type
        const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        if (!allowedTypes.includes(file.type)) {
            showResult('Format non supporte. Utilisez PDF ou DOCX.', 'error');
            return;
        }

        // Validate file size (10 MB)
        if (file.size > 10 * 1024 * 1024) {
            showResult('Fichier trop volumineux (max 10 Mo).', 'error');
            return;
        }

        // Show progress
        dropzone.style.display = 'none';
        progressDiv.classList.add('active');
        progressText.textContent = 'Envoi du fichier...';
        progressFill.style.width = '10%';

        // Create form data
        const formData = new FormData();
        formData.append('file', file);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        // Send request
        fetch('{% url "accounts:cv_upload" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.task_id) {
                // Start polling for status
                progressFill.style.width = '30%';
                progressText.textContent = 'Analyse du CV en cours...';
                pollForStatus(data.task_id);
            } else {
                showResult(data.error || 'Erreur lors de la soumission.', 'error');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showResult('Erreur de connexion au serveur.', 'error');
        });
    }

    function pollForStatus(taskId) {
        pollCount++;

        if (pollCount > MAX_POLL_ATTEMPTS) {
            showResult('L\'extraction prend trop de temps. Veuillez recharger la page.', 'error');
            return;
        }

        // Update progress animation
        const progress = Math.min(30 + (pollCount * 2), 90);
        progressFill.style.width = progress + '%';

        if (pollCount % 5 === 0) {
            const messages = [
                'Analyse du CV en cours...',
                'Extraction des experiences...',
                'Identification des competences...',
                'Traitement des formations...',
                'Finalisation...'
            ];
            const msgIndex = Math.min(Math.floor(pollCount / 5), messages.length - 1);
            progressText.textContent = messages[msgIndex];
        }

        fetch('/accounts/cv/status/' + taskId + '/')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'pending' || data.status === 'processing') {
                // Continue polling
                pollTimer = setTimeout(() => pollForStatus(taskId), POLL_INTERVAL);
            } else if (data.status === 'completed') {
                progressFill.style.width = '100%';
                progressText.textContent = 'Extraction terminee !';
                setTimeout(() => {
                    showResult(data.message || 'CV importe avec succes !', 'success');
                    // Reload page to show updated data, staying on documents section
                    setTimeout(() => {
                        window.location.hash = 'documents';
                        window.location.reload();
                    }, 1500);
                }, 500);
            } else if (data.status === 'failed') {
                showResult(data.error || 'L\'extraction a echoue.', 'error');
            } else {
                // Unknown status or error
                showResult(data.error || 'Erreur inattendue.', 'error');
            }
        })
        .catch(error => {
            console.error('Status check error:', error);
            // Retry on network error
            pollTimer = setTimeout(() => pollForStatus(taskId), POLL_INTERVAL);
        });
    }

    function showResult(message, type) {
        progressDiv.classList.remove('active');
        resultDiv.className = 'upload-result ' + type;
        resultDiv.textContent = message;
    }

    // Resume polling for CVs that are still processing
    function resumeProcessingCVs() {
        document.querySelectorAll('.document-item[data-status="processing"]').forEach(item => {
            const taskId = item.getAttribute('data-task-id');
            if (taskId) {
                console.log('Resuming polling for task:', taskId);
                pollExistingCV(taskId, item);
            }
        });
    }

    // Poll for an existing CV (without modal, updates DOM directly)
    function pollExistingCV(taskId, itemElement) {
        fetch('/accounts/cv/status/' + taskId + '/')
        .then(response => response.json())
        .then(data => {
            const statusSpan = itemElement.querySelector('.document-item-status');
            if (data.status === 'pending' || data.status === 'processing') {
                // Continue polling
                setTimeout(() => pollExistingCV(taskId, itemElement), POLL_INTERVAL);
            } else if (data.status === 'completed') {
                // Update status in DOM
                if (statusSpan) {
                    statusSpan.textContent = 'Extrait';
                    statusSpan.className = 'document-item-status completed';
                }
                itemElement.setAttribute('data-status', 'completed');
                // Reload page to show extracted lines
                setTimeout(() => {
                    window.location.hash = 'documents';
                    window.location.reload();
                }, 1000);
            } else if (data.status === 'failed') {
                if (statusSpan) {
                    statusSpan.textContent = 'Echec';
                    statusSpan.className = 'document-item-status failed';
                }
                itemElement.setAttribute('data-status', 'failed');
            }
        })
        .catch(error => {
            console.error('Status check error:', error);
            // Retry on network error
            setTimeout(() => pollExistingCV(taskId, itemElement), POLL_INTERVAL);
        });
    }

    // Start resuming processing CVs on page load
    resumeProcessingCVs();

    // CV Delete functionality
    const deleteModal = document.getElementById('cv-delete-modal');
    const deleteNameText = document.getElementById('delete-cv-name');
    const cancelDeleteBtn = document.getElementById('cancel-delete-cv');
    const confirmDeleteBtn = document.getElementById('confirm-delete-cv');
    let cvToDelete = null;

    // Add click handlers to all delete buttons
    document.querySelectorAll('.btn-delete-cv').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            cvToDelete = {
                id: this.getAttribute('data-cv-id'),
                name: this.getAttribute('data-cv-name')
            };
            if (deleteNameText) {
                deleteNameText.innerHTML = `<strong>${cvToDelete.name}</strong><br>Cette action supprimera egalement toutes les donnees extraites de ce CV.`;
            }
            if (deleteModal) {
                deleteModal.classList.add('active');
            }
        });
    });

    // Cancel delete
    if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', function() {
            if (deleteModal) deleteModal.classList.remove('active');
            cvToDelete = null;
        });
    }

    // Close on outside click
    if (deleteModal) {
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) {
                deleteModal.classList.remove('active');
                cvToDelete = null;
            }
        });
    }

    // Confirm delete
    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function() {
            if (!cvToDelete) return;

            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = 'Suppression...';

            fetch('/accounts/cv/delete/' + cvToDelete.id + '/', {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the CV item from the DOM
                    const cvItem = document.querySelector(`.document-item[data-cv-id="${cvToDelete.id}"]`);
                    if (cvItem) {
                        cvItem.remove();
                    }
                    // Check if list is empty and show empty message
                    const cvList = document.getElementById('cv-list');
                    if (cvList && cvList.querySelectorAll('.document-item').length === 0) {
                        cvList.innerHTML = '<div class="document-empty"><p>Aucun CV importe</p></div>';
                    }
                    if (deleteModal) deleteModal.classList.remove('active');
                    // Reload page to update extracted lines display, staying on documents section
                    window.location.hash = 'documents';
                    window.location.reload();
                } else {
                    alert(data.error || 'Erreur lors de la suppression.');
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.textContent = 'Supprimer';
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                alert('Erreur de connexion au serveur.');
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.textContent = 'Supprimer';
            });
        });
    }

    // Profile item toggle functionality
    document.querySelectorAll('.toggle-profile-item').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const lineId = parseInt(this.getAttribute('data-line-id'));
            toggleProfileItem(lineId, this);
        });
    });

    // Edit button click handler (placeholder for future implementation)
    document.querySelectorAll('.btn-edit-item').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const lineId = this.getAttribute('data-line-id');
            // TODO: Open edit modal or inline edit
            console.log('Edit line:', lineId);
            alert('Fonctionnalit d\'dition  venir');
        });
    });

    // Photo upload functionality
    const photoModal = document.getElementById('photoModal');
    const photoDropzone = document.getElementById('photoDropzone');
    const photoFileInput = document.getElementById('photoFileInput');
    const photoPreview = document.getElementById('photoPreview');
    const photoProgress = document.getElementById('photoProgress');
    const photoProgressFill = document.getElementById('photoProgressFill');

    if (photoDropzone) {
        // Click to select file
        photoDropzone.addEventListener('click', function() {
            photoFileInput.click();
        });

        // Drag and drop
        photoDropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        photoDropzone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });

        photoDropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handlePhotoFile(files[0]);
            }
        });
    }

    if (photoFileInput) {
        photoFileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handlePhotoFile(this.files[0]);
            }
        });
    }

    // Close photo modal on outside click
    if (photoModal) {
        photoModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closePhotoModal();
            }
        });
    }
});

// Photo modal functions
function openPhotoModal() {
    const modal = document.getElementById('photoModal');
    if (modal) {
        // Reset to step 1
        showPhotoStep(1);
        modal.classList.add('show');
    }
}

function closePhotoModal() {
    const modal = document.getElementById('photoModal');
    if (modal) {
        modal.classList.remove('show');
        // Destroy cropper if exists
        if (photoCropper) {
            photoCropper.destroy();
            photoCropper = null;
        }
        // Reset file input
        const fileInput = document.getElementById('photoFileInput');
        if (fileInput) fileInput.value = '';
    }
}

function showPhotoStep(step) {
    const step1 = document.getElementById('photoStep1');
    const step2 = document.getElementById('photoStep2');
    const footer1 = document.getElementById('photoFooter1');
    const footer2 = document.getElementById('photoFooter2');
    const title = document.getElementById('photoModalTitle');

    if (step === 1) {
        step1.style.display = 'block';
        step2.style.display = 'none';
        footer1.style.display = 'flex';
        footer2.style.display = 'none';
        title.textContent = 'Photo de profil';
    } else {
        step1.style.display = 'none';
        step2.style.display = 'block';
        footer1.style.display = 'none';
        footer2.style.display = 'flex';
        title.textContent = 'Recadrer la photo';
    }
}

function handlePhotoFile(file) {
    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!validTypes.includes(file.type)) {
        alert('Format non supporte. Utilisez JPG, PNG ou WebP.');
        return;
    }

    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        alert('La photo ne doit pas depasser 5 Mo');
        return;
    }

    // Load image and show cropper
    const reader = new FileReader();
    reader.onload = function(e) {
        const cropImage = document.getElementById('photoCropImage');
        cropImage.src = e.target.result;

        // Show step 2
        showPhotoStep(2);

        // Initialize cropper after image loads
        cropImage.onload = function() {
            // Destroy previous cropper if exists
            if (photoCropper) {
                photoCropper.destroy();
            }

            // Create new cropper with circular crop view
            photoCropper = new Cropper(cropImage, {
                aspectRatio: 1,
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 1,
                cropBoxMovable: false,
                cropBoxResizable: false,
                toggleDragModeOnDblclick: false,
                minContainerWidth: 250,
                minContainerHeight: 250,
                background: false,
                guides: false,
                center: false,
                highlight: false,
            });
        };
    };
    reader.readAsDataURL(file);
}

function cancelCrop() {
    // Destroy cropper
    if (photoCropper) {
        photoCropper.destroy();
        photoCropper = null;
    }
    // Reset file input
    const fileInput = document.getElementById('photoFileInput');
    if (fileInput) fileInput.value = '';
    // Go back to step 1
    showPhotoStep(1);
}

function applyCrop() {
    if (!photoCropper) return;

    // Get cropped canvas
    const canvas = photoCropper.getCroppedCanvas({
        width: 400,
        height: 400,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
    });

    if (!canvas) {
        alert('Erreur lors du recadrage');
        return;
    }

    // Convert to blob and upload
    canvas.toBlob(function(blob) {
        uploadPhoto(blob);
    }, 'image/jpeg', 0.9);
}

function uploadPhoto(blob) {
    const progress = document.getElementById('photoProgress');
    const progressFill = document.getElementById('photoProgressFill');

    // Show progress, hide step 2 content
    document.getElementById('photoStep2').style.display = 'none';
    document.getElementById('photoFooter2').style.display = 'none';
    progress.style.display = 'block';
    progressFill.style.width = '30%';

    const formData = new FormData();
    formData.append('photo', blob, 'profile.jpg');

    fetch('{% url "accounts:photo_upload" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
        },
        body: formData,
    })
    .then(response => {
        progressFill.style.width = '70%';
        return response.json();
    })
    .then(data => {
        progressFill.style.width = '100%';

        if (data.success) {
            // Destroy cropper
            if (photoCropper) {
                photoCropper.destroy();
                photoCropper = null;
            }

            // Update the sidebar photo
            const sidebarPhoto = document.querySelector('.profile-photo');
            if (sidebarPhoto) {
                sidebarPhoto.innerHTML = `<img src="${data.photo_url}" alt="Photo de profil">`;
            }

            // Update preview in modal step 1
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `<img src="${data.photo_url}" alt="Photo de profil" id="previewImg">`;

            // Show delete button if not present
            const footer1 = document.getElementById('photoFooter1');
            if (footer1 && !document.getElementById('btnDeletePhoto')) {
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.id = 'btnDeletePhoto';
                deleteBtn.className = 'photo-modal-btn delete';
                deleteBtn.onclick = deletePhoto;
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg> Supprimer`;
                footer1.insertBefore(deleteBtn, footer1.firstChild);
            }

            setTimeout(() => {
                progress.style.display = 'none';
                progressFill.style.width = '0%';
                // Go back to step 1
                showPhotoStep(1);
            }, 500);
        } else {
            alert(data.error || 'Erreur lors de l\'envoi de la photo');
            progress.style.display = 'none';
            progressFill.style.width = '0%';
            showPhotoStep(2);
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert('Erreur de connexion au serveur');
        progress.style.display = 'none';
        progressFill.style.width = '0%';
        showPhotoStep(2);
    });
}

function deletePhoto() {
    if (!confirm('Supprimer votre photo de profil ?')) {
        return;
    }

    fetch('{% url "accounts:photo_delete" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update sidebar photo with initial
            const sidebarPhoto = document.querySelector('.profile-photo');
            const userInitial = '{{ user.first_name|first|default:user.email|first|upper }}';
            if (sidebarPhoto) {
                sidebarPhoto.innerHTML = userInitial;
            }

            // Update preview with placeholder
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = `<div class="photo-preview-placeholder" id="previewPlaceholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </div>`;

            // Remove delete button
            const deleteBtn = document.getElementById('btnDeletePhoto');
            if (deleteBtn) {
                deleteBtn.remove();
            }
        } else {
            alert(data.error || 'Erreur lors de la suppression');
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('Erreur de connexion au serveur');
    });
}

// ============================================
// STAR Chat Functionality
// ============================================

class StarChatbot {
    constructor() {
        this.conversationId = null;
        this.isProcessing = false;
        this.pollInterval = null;
        this.useStreaming = true; // Enable streaming by default
        this.currentStreamingMessage = null; // Track the message being streamed

        // DOM elements
        this.chatMessages = document.getElementById('chat-messages');
        this.chatInputContainer = document.getElementById('chat-input-container');
        this.chatInput = document.getElementById('chat-input');
        this.chatSendBtn = document.getElementById('chat-send-btn');
        this.chatStartBtn = document.getElementById('chat-start-btn');
        this.chatNewBtn = document.getElementById('chat-new-btn');
        this.chatStatus = document.getElementById('chat-status');
        this.successesList = document.getElementById('successes-list');
        this.successesCount = document.getElementById('successes-count');
        this.successesEmpty = document.getElementById('successes-empty');
        this.chatExpandBtn = document.getElementById('chat-expand-btn');
        this.achievementsLayout = document.querySelector('#achievements .achievements-layout');

        this.init();
    }

    init() {
        // Bind events
        if (this.chatStartBtn) {
            this.chatStartBtn.addEventListener('click', () => this.startConversation());
        }
        if (this.chatNewBtn) {
            this.chatNewBtn.addEventListener('click', () => this.resetChat());
        }
        if (this.chatSendBtn) {
            this.chatSendBtn.addEventListener('click', () => this.sendMessage());
        }
        if (this.chatInput) {
            this.chatInput.addEventListener('input', () => this.updateSendButton());
            this.chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
        }
        if (this.chatExpandBtn) {
            this.chatExpandBtn.addEventListener('click', () => this.toggleExpand());
        }

        // Load existing successes
        this.loadSuccesses();
    }

    // Expand/collapse methods
    expandChat() {
        if (this.achievementsLayout) {
            this.achievementsLayout.classList.add('chat-expanded');
        }
    }

    collapseChat() {
        if (this.achievementsLayout) {
            this.achievementsLayout.classList.remove('chat-expanded');
        }
    }

    toggleExpand() {
        if (this.achievementsLayout) {
            this.achievementsLayout.classList.toggle('chat-expanded');
        }
    }

    async startConversation() {
        if (this.isProcessing) return;

        this.isProcessing = true;
        this.chatStatus.textContent = 'Demarrage...';
        this.chatStartBtn.disabled = true;

        // Auto-expand chat when conversation starts
        this.expandChat();

        // Use streaming if enabled
        if (this.useStreaming) {
            this.startConversationStreaming();
            return;
        }

        // Fallback to polling mode
        try {
            const response = await fetch('/accounts/api/chat/start/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
            });

            const data = await response.json();

            if (data.success) {
                this.conversationId = data.conversation_id;
                this.showChatInterface();
                // Show typing indicator while waiting for initial AI message
                this.showTypingIndicator();
                this.chatStatus.textContent = 'Reflexion...';
                this.pollForResponse(data.task_id);
            } else {
                this.showError(data.error || 'Erreur lors du demarrage');
                this.isProcessing = false;
                this.chatStartBtn.disabled = false;
            }
        } catch (error) {
            console.error('Start error:', error);
            this.showError('Erreur de connexion');
            this.isProcessing = false;
            this.chatStartBtn.disabled = false;
        }
        // Note: isProcessing will be set to false when polling completes
    }

    async startConversationStreaming() {
        this.showChatInterface();
        this.chatStatus.textContent = 'Connexion...';

        try {
            const response = await fetch('/accounts/api/chat/start/stream/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let messageCreated = false;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || ''; // Keep incomplete line in buffer

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;

                    const data = line.slice(6);
                    if (data === '[DONE]') {
                        this.finishStreamingMessage();
                        continue;
                    }

                    try {
                        const parsed = JSON.parse(data);

                        // First event contains conversation_id
                        if (parsed.conversation_id) {
                            this.conversationId = parsed.conversation_id;
                            this.chatStatus.textContent = 'Generation...';
                            continue;
                        }

                        // Handle errors
                        if (parsed.error) {
                            this.showError(parsed.error);
                            this.isProcessing = false;
                            continue;
                        }

                        // Handle token
                        if (parsed.token !== undefined) {
                            if (!messageCreated) {
                                this.createStreamingMessage('assistant');
                                messageCreated = true;
                            }
                            // Unescape newlines
                            const token = parsed.token.replace(/\\n/g, '\n');
                            this.appendToStreamingMessage(token);
                        }
                    } catch (e) {
                        console.warn('Parse error:', e, data);
                    }
                }
            }

            this.finishStreamingMessage();
            this.chatStatus.textContent = 'Connecte';
            this.isProcessing = false;
            this.chatSendBtn.disabled = false;

        } catch (error) {
            console.error('Streaming start error:', error);
            this.showError('Erreur de connexion');
            this.isProcessing = false;
            this.chatStartBtn.disabled = false;
        }
    }

    showChatInterface() {
        // Hide welcome, show messages area
        const welcome = this.chatMessages.querySelector('.chat-welcome');
        if (welcome) {
            welcome.style.display = 'none';
        }

        // Show input container
        this.chatInputContainer.style.display = 'flex';
    }

    resetChat() {
        this.conversationId = null;
        this.isProcessing = false;

        // Collapse chat when resetting
        this.collapseChat();

        if (this.pollInterval) {
            clearInterval(this.pollInterval);
            this.pollInterval = null;
        }

        // Clear messages except welcome
        this.chatMessages.innerHTML = `
            <div class="chat-welcome">
                <div class="chat-welcome-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                    </svg>
                </div>
                <h3 class="chat-welcome-title">Methode STAR</h3>
                <p class="chat-welcome-desc">Je vais vous guider pour structurer vos realisations professionnelles :</p>
                <ul class="chat-star-list">
                    <li><strong>S</strong>ituation - Le contexte</li>
                    <li><strong>T</strong>ache - Votre mission</li>
                    <li><strong>A</strong>ction - Ce que vous avez fait</li>
                    <li><strong>R</strong>esultat - L'impact mesurable</li>
                </ul>
                <button class="chat-start-btn" id="chat-start-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    Demarrer la conversation
                </button>
            </div>
        `;

        // Rebind start button
        const newStartBtn = document.getElementById('chat-start-btn');
        if (newStartBtn) {
            newStartBtn.addEventListener('click', () => this.startConversation());
        }

        // Hide input
        this.chatInputContainer.style.display = 'none';
        this.chatStatus.textContent = 'Pret a vous accompagner';
    }

    async sendMessage() {
        if (this.isProcessing || !this.conversationId) return;

        const message = this.chatInput.value.trim();
        if (!message) return;

        this.isProcessing = true;
        this.chatSendBtn.disabled = true;
        this.chatInput.value = '';
        this.updateSendButton();

        // Add user message to chat
        this.addMessage('user', message);

        // Use streaming if enabled
        if (this.useStreaming) {
            this.sendMessageStreaming(message);
            return;
        }

        // Fallback to polling mode
        this.showTypingIndicator();
        this.chatStatus.textContent = 'Reflexion...';

        try {
            const response = await fetch('/accounts/api/chat/message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    conversation_id: this.conversationId,
                    message: message,
                }),
            });

            const data = await response.json();

            if (data.success) {
                this.pollForResponse(data.task_id);
            } else {
                this.hideTypingIndicator();
                this.showError(data.error || 'Erreur lors de l\'envoi');
                this.isProcessing = false;
            }
        } catch (error) {
            console.error('Send error:', error);
            this.hideTypingIndicator();
            this.showError('Erreur de connexion');
            this.isProcessing = false;
        }
    }

    async sendMessageStreaming(message) {
        this.chatStatus.textContent = 'Generation...';

        try {
            const response = await fetch('/accounts/api/chat/message/stream/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    conversation_id: this.conversationId,
                    message: message,
                }),
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let messageCreated = false;

            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    console.log('Stream done, buffer remaining:', buffer);
                    break;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;

                    const data = line.slice(6);
                    if (data === '[DONE]') {
                        console.log('Received [DONE], calling finishStreamingMessage');
                        this.finishStreamingMessage();
                        continue;
                    }

                    try {
                        const parsed = JSON.parse(data);

                        // First event contains message IDs (skip)
                        if (parsed.user_message_id || parsed.assistant_message_id) {
                            continue;
                        }

                        // Handle errors
                        if (parsed.error) {
                            this.showError(parsed.error);
                            this.isProcessing = false;
                            continue;
                        }

                        // Handle token
                        if (parsed.token !== undefined) {
                            if (!messageCreated) {
                                this.createStreamingMessage('assistant');
                                messageCreated = true;
                            }
                            const token = parsed.token.replace(/\\n/g, '\n');
                            this.appendToStreamingMessage(token);
                        }
                    } catch (e) {
                        console.warn('Parse error:', e, data);
                    }
                }
            }

            // Process any remaining data in buffer after stream ends
            if (buffer.trim()) {
                console.log('Processing remaining buffer:', buffer);
                if (buffer.startsWith('data: ')) {
                    const data = buffer.slice(6);
                    if (data === '[DONE]') {
                        console.log('Found [DONE] in remaining buffer');
                    }
                }
            }

            console.log('Calling finishStreamingMessage after loop');
            this.finishStreamingMessage();
            this.chatStatus.textContent = 'Connecte';
            this.isProcessing = false;
            this.chatSendBtn.disabled = false;

        } catch (error) {
            console.error('Streaming message error:', error);
            this.showError('Erreur de connexion');
            this.isProcessing = false;
            this.chatSendBtn.disabled = false;
        }
    }

    pollForResponse(taskId) {
        let attempts = 0;
        const maxAttempts = 60; // 2 minutes max

        this.pollInterval = setInterval(async () => {
            attempts++;

            if (attempts > maxAttempts) {
                clearInterval(this.pollInterval);
                this.pollInterval = null;
                this.hideTypingIndicator();
                this.showError('Timeout - pas de reponse');
                this.isProcessing = false;
                this.chatSendBtn.disabled = false;
                return;
            }

            try {
                const response = await fetch(`/accounts/api/chat/status/${taskId}/`);
                const data = await response.json();

                if (data.status === 'completed') {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                    this.hideTypingIndicator();
                    this.addMessage('assistant', data.response);
                    this.chatStatus.textContent = 'Connecte';
                    this.isProcessing = false;
                    this.chatSendBtn.disabled = false;
                    this.scrollToBottom();
                } else if (data.status === 'failed') {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                    this.hideTypingIndicator();
                    this.showError(data.error || 'Erreur de generation');
                    this.isProcessing = false;
                    this.chatSendBtn.disabled = false;
                }
                // else: still processing, continue polling
            } catch (error) {
                console.error('Poll error:', error);
            }
        }, 2000); // Poll every 2 seconds
    }

    addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}`;

        const avatarSvg = role === 'assistant'
            ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>';

        // Use markdown for assistant messages, escape HTML for user messages
        const formattedContent = role === 'assistant' ? this.renderMarkdown(content) : this.escapeHtml(content);

        messageDiv.innerHTML = `
            <div class="chat-message-avatar">${avatarSvg}</div>
            <div class="chat-message-content">${formattedContent}</div>
        `;

        // Insert before typing indicator if present
        const typingIndicator = this.chatMessages.querySelector('.chat-message.typing');
        if (typingIndicator) {
            this.chatMessages.insertBefore(messageDiv, typingIndicator);
        } else {
            this.chatMessages.appendChild(messageDiv);
        }

        this.scrollToBottom();
    }

    renderMarkdown(text) {
        // Configure marked for safe rendering
        if (typeof marked !== 'undefined') {
            return marked.parse(text);
        }
        // Fallback if marked is not loaded
        return this.escapeHtml(text);
    }

    createStreamingMessage(role) {
        // Create an empty message element for streaming content
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role} streaming`;

        const avatarSvg = role === 'assistant'
            ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>';

        messageDiv.innerHTML = `
            <div class="chat-message-avatar">${avatarSvg}</div>
            <div class="chat-message-content"></div>
        `;

        this.chatMessages.appendChild(messageDiv);
        this.currentStreamingMessage = messageDiv;
        this.scrollToBottom();
    }

    appendToStreamingMessage(token) {
        if (!this.currentStreamingMessage) return;

        const contentDiv = this.currentStreamingMessage.querySelector('.chat-message-content');
        if (contentDiv) {
            // Unescape newlines from SSE format and append as text
            const unescapedToken = token.replace(/\\n/g, '\n');
            contentDiv.textContent += unescapedToken;
            this.scrollToBottom();
        }
    }

    finishStreamingMessage() {
        if (!this.currentStreamingMessage) return;

        // Remove streaming class
        this.currentStreamingMessage.classList.remove('streaming');

        // Apply markdown rendering to final content
        const contentDiv = this.currentStreamingMessage.querySelector('.chat-message-content');
        if (contentDiv) {
            const rawText = contentDiv.textContent || '';

            // Debug: log raw text to check markers
            console.log('finishStreamingMessage rawText:', rawText.substring(0, 200));
            console.log('Has START:', rawText.includes('[STAR_COMPLETE_START]'));
            console.log('Has END:', rawText.includes('[STAR_COMPLETE_END]'));

            // Check for STAR_COMPLETE markers (need both START and END)
            if (rawText.includes('[STAR_COMPLETE_START]') && rawText.includes('[STAR_COMPLETE_END]')) {
                this.handleStarComplete(rawText, contentDiv);
            } else {
                contentDiv.innerHTML = this.renderMarkdown(rawText);
            }
        }

        this.currentStreamingMessage = null;
    }

    async handleStarComplete(rawText, contentDiv) {
        // Extract the visible message (before the START marker)
        const startMarkerIndex = rawText.indexOf('[STAR_COMPLETE_START]');
        const visibleText = rawText.substring(0, startMarkerIndex).trim();

        // Show only the visible part to user (or a default message if empty)
        const displayText = visibleText || "Parfait ! Je cree ton succes...";
        contentDiv.innerHTML = this.renderMarkdown(displayText);

        // Extract JSON between START and END markers
        const jsonMatch = rawText.match(/\[STAR_COMPLETE_START\]\s*([\s\S]*?)\s*\[STAR_COMPLETE_END\]/);

        if (!jsonMatch) {
            console.error('STAR_COMPLETE markers found but no content between them. Raw:', rawText.substring(startMarkerIndex));
            this.showError('Le format de reponse est incorrect. Veuillez reessayer.');
            return;
        }

        let jsonText = jsonMatch[1].trim();

        // Remove any markdown code block markers if present
        jsonText = jsonText.replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/\s*```$/i, '');

        if (!jsonText) {
            console.error('STAR_COMPLETE markers found but empty JSON. Raw:', rawText.substring(startMarkerIndex));
            this.showError('Le format de reponse est incorrect. Veuillez reessayer.');
            return;
        }

        try {
            // Clean up the JSON text (remove leading/trailing whitespace, fix common issues)
            jsonText = jsonText.trim();
            const successData = JSON.parse(jsonText);

            // Validate required fields
            if (!successData.title) {
                throw new Error('Missing title in success data');
            }

            // Create the success via API
            const response = await fetch('/accounts/api/successes/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    title: successData.title,
                    situation: successData.situation || '',
                    task: successData.task || '',
                    action: successData.action || '',
                    result: successData.result || '',
                    skills_demonstrated: successData.skills_demonstrated || [],
                    conversation_id: this.conversationId,
                    is_draft: false, // Success is complete when auto-created
                }),
            });

            const result = await response.json();

            if (result.success) {
                // Reset chat first
                this.resetChat();

                // Reload successes list
                this.loadSuccesses();

                // Show success modal
                showSuccessModal();
            } else {
                console.error('Failed to create success:', result.error);
                this.showError('Erreur lors de la creation du succes: ' + (result.error || 'erreur inconnue'));
            }
        } catch (e) {
            console.error('Error parsing STAR_COMPLETE JSON:', e, 'Raw JSON:', jsonText);
            this.showError('Erreur de format JSON. Veuillez reessayer.');
        }
    }

    showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chat-message assistant typing';
        typingDiv.innerHTML = `
            <div class="chat-message-avatar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
            </div>
            <div class="chat-message-content">
                <div class="chat-typing">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        this.chatMessages.appendChild(typingDiv);
        this.scrollToBottom();
    }

    hideTypingIndicator() {
        const typing = this.chatMessages.querySelector('.chat-message.typing');
        if (typing) {
            typing.remove();
        }
    }

    showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'chat-message assistant';
        errorDiv.innerHTML = `
            <div class="chat-message-avatar" style="background: #ef4444;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="chat-message-content" style="border-color: #fecaca; background: #fef2f2; color: #dc2626;">
                ${this.escapeHtml(message)}
            </div>
        `;
        this.chatMessages.appendChild(errorDiv);
        this.scrollToBottom();
        this.chatStatus.textContent = 'Erreur';
    }

    updateSendButton() {
        const hasText = this.chatInput.value.trim().length > 0;
        this.chatSendBtn.disabled = !hasText || this.isProcessing;
    }

    scrollToBottom() {
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\n/g, '<br>');
    }

    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }

    // Load existing successes
    async loadSuccesses() {
        try {
            const response = await fetch('/accounts/api/successes/');
            const data = await response.json();

            if (data.success) {
                this.renderSuccesses(data.successes);
            }
        } catch (error) {
            console.error('Load successes error:', error);
        }
    }

    renderSuccesses(successes) {
        this.successesCount.textContent = successes.length;
        // Store successes for later use in modals
        this.successes = successes;

        if (successes.length === 0) {
            this.successesEmpty.style.display = 'flex';
            return;
        }

        this.successesEmpty.style.display = 'none';

        // Clear existing cards (keep empty message hidden)
        const existingCards = this.successesList.querySelectorAll('.success-card');
        existingCards.forEach(card => card.remove());

        // Add success cards
        successes.forEach(success => {
            const card = document.createElement('div');
            card.className = 'success-card';
            card.dataset.successId = success.id;
            card.innerHTML = `
                <div class="success-card-header">
                    <h4 class="success-card-title">${this.escapeHtml(success.title)}</h4>
                    <span class="success-card-badge ${success.is_draft ? 'draft' : 'complete'}">
                        ${success.is_draft ? 'Brouillon' : 'Finalise'}
                    </span>
                </div>
                <div class="success-card-progress">
                    <div class="success-card-progress-bar">
                        <div class="success-card-progress-fill" style="width: ${success.completion_percentage}%;"></div>
                    </div>
                    <span>${success.completion_percentage}%</span>
                </div>
                <div class="success-card-actions">
                    <div class="success-card-toggle">
                        <label class="toggle-switch" title="Inclure dans ce profil">
                            <input type="checkbox" class="toggle-success-profile" data-success-id="${success.id}" ${success.is_active !== false ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                        <span>Profil</span>
                    </div>
                    <div class="success-card-buttons">
                        <button type="button" class="success-card-btn view" data-success-id="${success.id}" title="Voir le detail">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                        <button type="button" class="success-card-btn delete" data-success-id="${success.id}" data-success-title="${this.escapeHtml(success.title)}" title="Supprimer">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            this.successesList.appendChild(card);
        });

        // Add event listeners for view and delete buttons
        this.successesList.querySelectorAll('.success-card-btn.view').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const successId = parseInt(btn.dataset.successId);
                this.viewSuccess(successId);
            });
        });

        this.successesList.querySelectorAll('.success-card-btn.delete').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const successId = parseInt(btn.dataset.successId);
                const successTitle = btn.dataset.successTitle;
                this.showDeleteModal(successId, successTitle);
            });
        });

        // Add event listeners for toggle
        this.successesList.querySelectorAll('.toggle-success-profile').forEach(toggle => {
            toggle.addEventListener('change', (e) => {
                const successId = parseInt(toggle.dataset.successId);
                this.toggleSuccessProfile(successId, toggle.checked);
            });
        });
    }

    viewSuccess(successId) {
        const success = this.successes.find(s => s.id === successId);
        if (!success) return;

        document.getElementById('successViewTitle').textContent = success.title;
        document.getElementById('successViewSituation').textContent = success.situation || '-';
        document.getElementById('successViewTask').textContent = success.task || '-';
        document.getElementById('successViewAction').textContent = success.action || '-';
        document.getElementById('successViewResult').textContent = success.result || '-';

        const skillsContainer = document.getElementById('successViewSkills');
        skillsContainer.innerHTML = '';
        if (success.skills_demonstrated && success.skills_demonstrated.length > 0) {
            success.skills_demonstrated.forEach(skill => {
                const tag = document.createElement('span');
                tag.style.cssText = 'background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 12px; font-size: 12px;';
                tag.textContent = skill;
                skillsContainer.appendChild(tag);
            });
        } else {
            skillsContainer.innerHTML = '<span style="color: #9ca3af; font-size: 12px;">Aucune competence</span>';
        }

        document.getElementById('successViewModal').classList.add('show');
    }

    showDeleteModal(successId, successTitle) {
        this.successToDelete = successId;
        document.getElementById('successDeleteTitle').innerHTML = `<strong>${successTitle}</strong><br>Cette action est irreversible.`;
        document.getElementById('successDeleteModal').classList.add('show');
    }

    async deleteSuccess(successId) {
        try {
            const response = await fetch(`/accounts/api/successes/${successId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            });

            if (response.ok) {
                // Reload successes
                await this.loadSuccesses();
            } else {
                console.error('Delete failed');
                alert('Erreur lors de la suppression');
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('Erreur lors de la suppression');
        }
    }

    async toggleSuccessProfile(successId, isActive) {
        try {
            const response = await fetch(`/accounts/api/successes/${successId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({ is_active: isActive })
            });

            if (!response.ok) {
                console.error('Toggle failed');
                // Revert the checkbox
                const checkbox = this.successesList.querySelector(`.toggle-success-profile[data-success-id="${successId}"]`);
                if (checkbox) checkbox.checked = !isActive;
            }
        } catch (error) {
            console.error('Toggle error:', error);
        }
    }
}

// ============================================
// Pitch Chat Functionality
// ============================================

class PitchChatbot {
    constructor() {
        this.conversationId = null;
        this.isProcessing = false;
        this.pollInterval = null;
        this.useStreaming = true; // Enable streaming by default
        this.currentStreamingMessage = null; // Track the message being streamed

        // DOM elements
        this.chatMessages = document.getElementById('pitch-chat-messages');
        this.chatInputContainer = document.getElementById('pitch-chat-input-container');
        this.chatInput = document.getElementById('pitch-chat-input');
        this.chatSendBtn = document.getElementById('pitch-chat-send-btn');
        this.chatStartBtn = document.getElementById('pitch-chat-start-btn');
        this.chatNewBtn = document.getElementById('pitch-chat-new-btn');
        this.chatStatus = document.getElementById('pitch-chat-status');
        this.pitchesList = document.getElementById('pitches-list');
        this.pitchesCount = document.getElementById('pitches-count');
        this.pitchesEmpty = document.getElementById('pitches-empty');
        this.chatExpandBtn = document.getElementById('pitch-chat-expand-btn');
        this.pitchLayout = document.querySelector('#pitch .achievements-layout');

        this.init();
    }

    init() {
        // Bind events
        if (this.chatStartBtn) {
            this.chatStartBtn.addEventListener('click', () => this.startConversation());
        }
        if (this.chatNewBtn) {
            this.chatNewBtn.addEventListener('click', () => this.resetChat());
        }
        if (this.chatSendBtn) {
            this.chatSendBtn.addEventListener('click', () => this.sendMessage());
        }
        if (this.chatInput) {
            this.chatInput.addEventListener('input', () => this.updateSendButton());
            this.chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
        }
        if (this.chatExpandBtn) {
            this.chatExpandBtn.addEventListener('click', () => this.toggleExpand());
        }

        // Load existing pitches
        this.loadPitches();
    }

    // Expand/collapse methods
    expandChat() {
        if (this.pitchLayout) {
            this.pitchLayout.classList.add('chat-expanded');
        }
    }

    collapseChat() {
        if (this.pitchLayout) {
            this.pitchLayout.classList.remove('chat-expanded');
        }
    }

    toggleExpand() {
        if (this.pitchLayout) {
            this.pitchLayout.classList.toggle('chat-expanded');
        }
    }

    async startConversation() {
        if (this.isProcessing) return;

        this.isProcessing = true;
        this.chatStatus.textContent = 'Demarrage...';
        this.chatStartBtn.disabled = true;

        // Auto-expand chat when conversation starts
        this.expandChat();

        // Use streaming if enabled
        if (this.useStreaming) {
            this.startConversationStreaming();
            return;
        }

        // Fallback to polling mode
        try {
            const response = await fetch('/accounts/api/chat/start/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    coaching_type: 'pitch'
                }),
            });

            const data = await response.json();

            if (data.success) {
                this.conversationId = data.conversation_id;
                this.showChatInterface();
                // Show typing indicator while waiting for initial AI message
                this.showTypingIndicator();
                this.chatStatus.textContent = 'Reflexion...';
                this.pollForResponse(data.task_id);
            } else {
                this.showError(data.error || 'Erreur lors du demarrage');
                this.isProcessing = false;
                this.chatStartBtn.disabled = false;
            }
        } catch (error) {
            console.error('Start error:', error);
            this.showError('Erreur de connexion');
            this.isProcessing = false;
            this.chatStartBtn.disabled = false;
        }
        // Note: isProcessing will be set to false when polling completes
    }

    async startConversationStreaming() {
        this.showChatInterface();
        this.chatStatus.textContent = 'Connexion...';

        try {
            const response = await fetch('/accounts/api/chat/start/stream/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    coaching_type: 'pitch'
                }),
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let messageCreated = false;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;

                    const data = line.slice(6);
                    if (data === '[DONE]') {
                        this.finishStreamingMessage();
                        continue;
                    }

                    try {
                        const parsed = JSON.parse(data);

                        if (parsed.conversation_id) {
                            this.conversationId = parsed.conversation_id;
                            this.chatStatus.textContent = 'Generation...';
                            continue;
                        }

                        if (parsed.error) {
                            this.showError(parsed.error);
                            this.isProcessing = false;
                            continue;
                        }

                        if (parsed.token !== undefined) {
                            if (!messageCreated) {
                                this.createStreamingMessage('assistant');
                                messageCreated = true;
                            }
                            const token = parsed.token.replace(/\\n/g, '\n');
                            this.appendToStreamingMessage(token);
                        }
                    } catch (e) {
                        console.warn('Parse error:', e, data);
                    }
                }
            }

            this.finishStreamingMessage();
            this.chatStatus.textContent = 'Connecte';
            this.isProcessing = false;
            this.chatSendBtn.disabled = false;

        } catch (error) {
            console.error('Streaming start error:', error);
            this.showError('Erreur de connexion');
            this.isProcessing = false;
            this.chatStartBtn.disabled = false;
        }
    }

    showChatInterface() {
        // Hide welcome, show messages area
        const welcome = this.chatMessages.querySelector('.chat-welcome');
        if (welcome) {
            welcome.style.display = 'none';
        }

        // Show input container
        this.chatInputContainer.style.display = 'flex';
    }

    resetChat() {
        this.conversationId = null;
        this.isProcessing = false;

        // Collapse chat when resetting
        this.collapseChat();

        if (this.pollInterval) {
            clearInterval(this.pollInterval);
            this.pollInterval = null;
        }

        // Clear messages except welcome
        this.chatMessages.innerHTML = `
            <div class="chat-welcome pitch-welcome">
                <div class="chat-welcome-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </div>
                <h3 class="chat-welcome-title">Creez votre pitch</h3>
                <p class="chat-welcome-desc">Je vais vous aider a creer deux pitchs percutants :</p>
                <ul class="chat-star-list pitch-list">
                    <li><strong>30s</strong> - Elevator pitch pour captiver rapidement</li>
                    <li><strong>3min</strong> - Pitch detaille pour les entretiens</li>
                </ul>
                <p class="chat-welcome-note">Vos succes professionnels seront utilises pour enrichir votre pitch.</p>
                <button class="chat-start-btn pitch-start-btn" id="pitch-chat-start-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    Demarrer la conversation
                </button>
            </div>
        `;

        // Rebind start button
        const newStartBtn = document.getElementById('pitch-chat-start-btn');
        if (newStartBtn) {
            newStartBtn.addEventListener('click', () => this.startConversation());
        }

        // Hide input
        this.chatInputContainer.style.display = 'none';
        this.chatStatus.textContent = 'Pret a vous accompagner';
    }

    async sendMessage() {
        if (this.isProcessing || !this.conversationId) return;

        const message = this.chatInput.value.trim();
        if (!message) return;

        this.isProcessing = true;
        this.chatSendBtn.disabled = true;
        this.chatInput.value = '';
        this.updateSendButton();

        // Add user message to chat
        this.addMessage('user', message);

        // Use streaming if enabled
        if (this.useStreaming) {
            this.sendMessageStreaming(message);
            return;
        }

        // Fallback to polling mode
        this.showTypingIndicator();
        this.chatStatus.textContent = 'Reflexion...';

        try {
            const response = await fetch('/accounts/api/chat/message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    conversation_id: this.conversationId,
                    message: message,
                }),
            });

            const data = await response.json();

            if (data.success) {
                this.pollForResponse(data.task_id);
            } else {
                this.hideTypingIndicator();
                this.showError(data.error || 'Erreur lors de l\'envoi');
                this.isProcessing = false;
            }
        } catch (error) {
            console.error('Send error:', error);
            this.hideTypingIndicator();
            this.showError('Erreur de connexion');
            this.isProcessing = false;
        }
    }

    async sendMessageStreaming(message) {
        this.chatStatus.textContent = 'Generation...';

        try {
            const response = await fetch('/accounts/api/chat/message/stream/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken(),
                },
                body: JSON.stringify({
                    conversation_id: this.conversationId,
                    message: message,
                }),
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let messageCreated = false;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;

                    const data = line.slice(6);
                    if (data === '[DONE]') {
                        this.finishStreamingMessage();
                        continue;
                    }

                    try {
                        const parsed = JSON.parse(data);

                        if (parsed.user_message_id || parsed.assistant_message_id) {
                            continue;
                        }

                        if (parsed.error) {
                            this.showError(parsed.error);
                            this.isProcessing = false;
                            continue;
                        }

                        if (parsed.token !== undefined) {
                            if (!messageCreated) {
                                this.createStreamingMessage('assistant');
                                messageCreated = true;
                            }
                            const token = parsed.token.replace(/\\n/g, '\n');
                            this.appendToStreamingMessage(token);
                        }
                    } catch (e) {
                        console.warn('Parse error:', e, data);
                    }
                }
            }

            this.finishStreamingMessage();
            this.chatStatus.textContent = 'Connecte';
            this.isProcessing = false;
            this.chatSendBtn.disabled = false;

        } catch (error) {
            console.error('Streaming message error:', error);
            this.showError('Erreur de connexion');
            this.isProcessing = false;
            this.chatSendBtn.disabled = false;
        }
    }

    pollForResponse(taskId) {
        let attempts = 0;
        const maxAttempts = 60; // 2 minutes max

        this.pollInterval = setInterval(async () => {
            attempts++;

            if (attempts > maxAttempts) {
                clearInterval(this.pollInterval);
                this.pollInterval = null;
                this.hideTypingIndicator();
                this.showError('Timeout - pas de reponse');
                this.isProcessing = false;
                this.chatSendBtn.disabled = false;
                return;
            }

            try {
                const response = await fetch(`/accounts/api/chat/status/${taskId}/`);
                const data = await response.json();

                if (data.status === 'completed') {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                    this.hideTypingIndicator();
                    this.addMessage('assistant', data.response);
                    this.chatStatus.textContent = 'Connecte';
                    this.isProcessing = false;
                    this.chatSendBtn.disabled = false;
                    this.scrollToBottom();
                } else if (data.status === 'failed') {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                    this.hideTypingIndicator();
                    this.showError(data.error || 'Erreur de generation');
                    this.isProcessing = false;
                    this.chatSendBtn.disabled = false;
                }
                // else: still processing, continue polling
            } catch (error) {
                console.error('Poll error:', error);
            }
        }, 2000); // Poll every 2 seconds
    }

    addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}`;

        const avatarSvg = role === 'assistant'
            ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>';

        const avatarStyle = role === 'assistant' ? 'style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);"' : '';

        // Use markdown for assistant messages, escape HTML for user messages
        const formattedContent = role === 'assistant' ? this.renderMarkdown(content) : this.escapeHtml(content);

        messageDiv.innerHTML = `
            <div class="chat-message-avatar" ${avatarStyle}>${avatarSvg}</div>
            <div class="chat-message-content">${formattedContent}</div>
        `;

        // Insert before typing indicator if present
        const typingIndicator = this.chatMessages.querySelector('.chat-message.typing');
        if (typingIndicator) {
            this.chatMessages.insertBefore(messageDiv, typingIndicator);
        } else {
            this.chatMessages.appendChild(messageDiv);
        }

        this.scrollToBottom();
    }

    renderMarkdown(text) {
        // Configure marked for safe rendering
        if (typeof marked !== 'undefined') {
            return marked.parse(text);
        }
        // Fallback if marked is not loaded
        return this.escapeHtml(text);
    }

    // Streaming helper methods
    createStreamingMessage(role) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role} streaming`;

        const avatarSvg = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>';

        messageDiv.innerHTML = `
            <div class="chat-message-avatar" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">${avatarSvg}</div>
            <div class="chat-message-content"></div>
        `;

        this.chatMessages.appendChild(messageDiv);
        this.currentStreamingMessage = messageDiv;
        this.scrollToBottom();
        return messageDiv;
    }

    appendToStreamingMessage(token) {
        if (!this.currentStreamingMessage) return;

        const contentDiv = this.currentStreamingMessage.querySelector('.chat-message-content');
        if (contentDiv) {
            // Unescape newlines from SSE format and append as text
            const unescapedToken = token.replace(/\\n/g, '\n');
            contentDiv.textContent += unescapedToken;
            this.scrollToBottom();
        }
    }

    finishStreamingMessage() {
        if (!this.currentStreamingMessage) return;

        this.currentStreamingMessage.classList.remove('streaming');

        // Apply markdown rendering to final content
        const contentDiv = this.currentStreamingMessage.querySelector('.chat-message-content');
        if (contentDiv) {
            const rawText = contentDiv.textContent || '';
            contentDiv.innerHTML = this.renderMarkdown(rawText);
        }

        this.currentStreamingMessage = null;
    }

    showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chat-message assistant typing';
        typingDiv.innerHTML = `
            <div class="chat-message-avatar" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </div>
            <div class="chat-message-content">
                <div class="chat-typing">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        this.chatMessages.appendChild(typingDiv);
        this.scrollToBottom();
    }

    hideTypingIndicator() {
        const typing = this.chatMessages.querySelector('.chat-message.typing');
        if (typing) {
            typing.remove();
        }
    }

    showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'chat-message assistant';
        errorDiv.innerHTML = `
            <div class="chat-message-avatar" style="background: #ef4444;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div class="chat-message-content" style="border-color: #fecaca; background: #fef2f2; color: #dc2626;">
                ${this.escapeHtml(message)}
            </div>
        `;
        this.chatMessages.appendChild(errorDiv);
        this.scrollToBottom();
        this.chatStatus.textContent = 'Erreur';
    }

    updateSendButton() {
        const hasText = this.chatInput.value.trim().length > 0;
        this.chatSendBtn.disabled = !hasText || this.isProcessing;
    }

    scrollToBottom() {
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\n/g, '<br>');
    }

    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    }

    // Load existing pitches
    async loadPitches() {
        try {
            const response = await fetch('/accounts/api/pitches/');
            const data = await response.json();

            if (data.success) {
                this.renderPitches(data.pitches);
            }
        } catch (error) {
            console.error('Load pitches error:', error);
        }
    }

    renderPitches(pitches) {
        this.pitchesCount.textContent = pitches.length;

        if (pitches.length === 0) {
            this.pitchesEmpty.style.display = 'flex';
            return;
        }

        this.pitchesEmpty.style.display = 'none';

        // Clear existing cards (keep empty message hidden)
        const existingCards = this.pitchesList.querySelectorAll('.success-card');
        existingCards.forEach(card => card.remove());

        // Add pitch cards
        pitches.forEach(pitch => {
            const card = document.createElement('div');
            card.className = 'success-card pitch-card';
            const completion = pitch.is_complete ? 100 : (pitch.word_count_30s > 0 ? 50 : 0);
            card.innerHTML = `
                <div class="success-card-header">
                    <h4 class="success-card-title">${this.escapeHtml(pitch.title)}</h4>
                    <span class="success-card-badge ${pitch.is_draft ? 'draft' : 'complete'}">
                        ${pitch.is_draft ? 'Brouillon' : 'Finalise'}
                    </span>
                </div>
                <div class="pitch-card-info">
                    <span class="pitch-word-count">30s: ${pitch.word_count_30s} mots</span>
                    <span class="pitch-word-count">3min: ${pitch.word_count_3min} mots</span>
                </div>
                <div class="success-card-progress">
                    <div class="success-card-progress-bar">
                        <div class="success-card-progress-fill" style="width: ${completion}%; background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);"></div>
                    </div>
                    <span>${completion}%</span>
                </div>
            `;
            this.pitchesList.appendChild(card);
        });
    }
}

// Initialize chat when sections become visible
document.addEventListener('DOMContentLoaded', function() {
    let pitchChatInstance = null;
    // Make starChatInstance globally accessible for modal functions
    window.starChatInstance = null;

    // Initialize STAR chat when achievements section becomes visible
    const achievementsSection = document.getElementById('achievements');
    if (achievementsSection) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'style') {
                    const isVisible = achievementsSection.style.display !== 'none';
                    if (isVisible && !window.starChatInstance) {
                        window.starChatInstance = new StarChatbot();
                    }
                }
            });
        });

        observer.observe(achievementsSection, { attributes: true });

        // Also check if already visible
        if (achievementsSection.style.display !== 'none') {
            window.starChatInstance = new StarChatbot();
        }
    }

    // Initialize Pitch chat when pitch section becomes visible
    const pitchSection = document.getElementById('pitch');
    if (pitchSection) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'style') {
                    const isVisible = pitchSection.style.display !== 'none';
                    if (isVisible && !pitchChatInstance) {
                        pitchChatInstance = new PitchChatbot();
                    }
                }
            });
        });

        observer.observe(pitchSection, { attributes: true });

        // Also check if already visible
        if (pitchSection.style.display !== 'none') {
            pitchChatInstance = new PitchChatbot();
        }
    }
});
</script>
{% endblock %}
