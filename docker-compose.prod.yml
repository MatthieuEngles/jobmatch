# =============================================================================
# JobMatch Production Docker Compose
# Services: GUI, CV-ingestion, AI-assistant, Matching, PostgreSQL, Redis
# Airflow and offre-ingestion are managed externally
# =============================================================================

services:
  gui:
    build:
      context: .
      dockerfile: app/gui/Dockerfile
    image: jobmatch-gui:latest
    ports:
      - "8085:8080"
    environment:
      - ENV_MODE=production
      - DEBUG=false
      # PostgreSQL
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=jobmatch
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=jobmatch
      # Service URLs (internal docker network)
      - CV_INGESTION_URL=http://cv-ingestion:8081
      - MATCHING_URL=http://matching:8086
      - AI_ASSISTANT_URL=http://ai-assistant:8084
      - MATCHING_SERVICE_URL=http://matching:8086
      # BigQuery cross-project Gold access
      - USE_MOCK_MATCHING=false
      - USE_SQLITE_OFFERS=false
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - BIGQUERY_GOLD_PROJECT_ID=${BIGQUERY_GOLD_PROJECT_ID}
      - BIGQUERY_GOLD_CROSS_PROJECT_DATASET=${BIGQUERY_GOLD_CROSS_PROJECT_DATASET}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/bigquery-gold-key.json
      # Embeddings
      - EMBEDDINGS_PROVIDER=${EMBEDDINGS_PROVIDER:-sentence-transformers}
      - EMBEDDINGS_MODEL=${EMBEDDINGS_MODEL:-paraphrase-multilingual-MiniLM-L12-v2}
    volumes:
      # BigQuery Gold SA key from Secret Manager (mounted by startup script)
      - /opt/jobmatch/secrets/bigquery-gold-key.json:/app/credentials/bigquery-gold-key.json:ro
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - jobmatch-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  cv-ingestion:
    build:
      context: .
      dockerfile: app/cv-ingestion/Dockerfile
    image: jobmatch-cv-ingestion:latest
    ports:
      - "8081:8081"
    environment:
      - DEBUG=false
      # LLM Configuration (Gemini via Vertex AI - uses ADC)
      - LLM_TYPE=gemini
      - LLM_MODEL=${LLM_MODEL:-gemini-1.5-flash-002}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-4096}
      # GCP Configuration for Vertex AI
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCP_LOCATION=${GCP_LOCATION:-europe-west1}
    restart: unless-stopped
    networks:
      - jobmatch-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8081/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  ai-assistant:
    build:
      context: .
      dockerfile: app/ai-assistant/Dockerfile
    image: jobmatch-ai-assistant:latest
    ports:
      - "8084:8084"
    environment:
      - DEBUG=false
      # LLM Configuration (Gemini via Vertex AI - uses ADC)
      - LLM_TYPE=gemini
      - LLM_MODEL=${LLM_MODEL:-gemini-1.5-flash-002}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-4096}
      # GCP Configuration for Vertex AI
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCP_LOCATION=${GCP_LOCATION:-europe-west1}
    restart: unless-stopped
    networks:
      - jobmatch-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  matching:
    build:
      context: .
      dockerfile: app/matching/Dockerfile
    image: jobmatch-matching:latest
    ports:
      - "8086:8086"
    environment:
      - DEBUG=false
      - CV_INGESTION_URL=http://cv-ingestion:8081
    depends_on:
      cv-ingestion:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - jobmatch-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=jobmatch
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=jobmatch
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - jobmatch-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jobmatch -d jobmatch"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    networks:
      - jobmatch-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  jobmatch-network:
    driver: bridge

volumes:
  postgres_data:
