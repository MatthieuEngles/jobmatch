# Shared Package Installation Status Across Services

This document tracks how the `jobmatch-shared` package is installed in each service.

## Summary

| Service | Shared Package | Embeddings Support | Installation Type | Status |
|---------|---------------|-------------------|-------------------|--------|
| **gui** | ✅ Yes | ✅ Yes | `pip install -e "/app/shared[embeddings]"` | ✅ Fixed |
| **matching** | ✅ Yes | ✅ Yes | `pip install -e "/app/shared[embeddings]"` | ✅ Fixed |
| **offre-ingestion** | ✅ Yes | ✅ Yes | `pip install --no-cache-dir "/tmp/jobmatch-shared[embeddings]"` | ✅ Already correct |
| **cv-ingestion** | ✅ Yes | ❌ No | `pip install --no-cache-dir -e ./shared` | ✅ Fixed (editable mode) |
| **ai-assistant** | ❌ No | ❌ No | N/A | ⚠️ Not needed |

## Details

### GUI Service
**File**: `app/gui/Dockerfile`

```dockerfile
# Copy shared package and install with embeddings support
COPY shared /app/shared
RUN pip install -e "/app/shared[embeddings]"
```

**Why embeddings?** The GUI service uses `shared.embeddings` to:
- Generate embeddings for user profiles (title and CV text)
- Call the matching service with embedded vectors
- Provide the "top offers" feature

**Changed**: Added `[embeddings]` extra to ensure sentence-transformers is installed.

---

### Matching Service
**File**: `app/matching/Dockerfile`

```dockerfile
# Copy shared package and install with embeddings support
COPY shared /app/shared
RUN pip install -e "/app/shared[embeddings]"
```

**Why embeddings?** The matching service:
- Computes similarity between job offers and candidate profiles
- Uses embeddings for semantic matching
- Requires numpy and sentence-transformers

**Changed**: Added `[embeddings]` extra.

---

### Offre Ingestion Service
**File**: `app/offre-ingestion/Dockerfile`

```dockerfile
# Copier et installer le package jobmatch-shared
COPY shared /tmp/jobmatch-shared
RUN pip install --no-cache-dir "/tmp/jobmatch-shared[embeddings]"
```

**Why embeddings?** The offre-ingestion service:
- Pre-computes embeddings for job offers
- Stores embeddings in the database for faster matching

**Status**: Already correct! ✅

---

### CV Ingestion Service
**File**: `app/cv-ingestion/Dockerfile`

```dockerfile
# Copy shared package first (for Docker layer caching)
COPY shared/ ./shared/
RUN pip install --no-cache-dir -e ./shared && pip install --no-cache-dir -r requirements.txt
```

**Why no embeddings?** The cv-ingestion service:
- Only uses shared package for data models (interfaces, constants)
- Does not perform embedding computations
- Embeddings are generated by the GUI when needed

**Changed**: Added `-e` flag for editable mode (better for development).

---

### AI Assistant Service
**File**: `app/ai-assistant/Dockerfile`

**No shared package installation** - This service:
- Generates CV and cover letters using LLMs
- Does not use shared data models or embeddings
- Independent microservice

---

## Dependencies in pyproject.toml

### Core Dependencies (always installed)
```toml
dependencies = [
    "pydantic>=2.0.0",
    "numpy>=1.24.0",
]
```

**Key fix**: Added `numpy>=1.24.0` to core dependencies because:
- It's imported directly in `shared/src/shared/embeddings/providers.py`
- Required even without sentence-transformers
- Was causing import errors before

### Optional Dependencies
```toml
[project.optional-dependencies]
embeddings = [
    "sentence-transformers>=2.0.0",
    "vec2vec>=0.0.5",
]
```

---

## Installation Commands Summary

### For services that need embeddings:
```bash
pip install -e "/path/to/shared[embeddings]"
```

This installs:
- pydantic
- numpy
- sentence-transformers
- vec2vec

### For services that only need core shared:
```bash
pip install -e /path/to/shared
```

This installs:
- pydantic
- numpy

---

## Verification

After rebuilding containers, verify installation:

```bash
# Check GUI container
docker compose exec gui python -c "from shared.embeddings import create_embedder; print('✓ GUI OK')"

# Check matching container
docker compose exec matching python -c "from shared.embeddings import create_embedder; print('✓ Matching OK')"

# Check offre-ingestion container
docker compose exec offre-ingestion python -c "from shared.embeddings import create_embedder; print('✓ Offre-ingestion OK')"

# Check cv-ingestion container (should work without embeddings)
docker compose exec cv-ingestion python -c "from shared.interfaces import CVData; print('✓ CV-ingestion OK')"
```

---

## Rebuild Instructions

To apply these changes:

```bash
# Rebuild all affected services
docker compose build gui matching offre-ingestion cv-ingestion

# Or rebuild everything
docker compose build

# Start services
docker compose up -d
```
